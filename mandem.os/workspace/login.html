<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://barbrickdesign.github.io/">
    <meta name="twitter:title" content="BARBRICKDESIGN - Elite Web3 Hub">
    <meta name="twitter:description" content="Cutting-edge Web3 development and design solutions">
    <meta name="twitter:image" content="https://barbrickdesign.github.io/header.jpg">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://barbrickdesign.github.io/">
    <meta property="og:title" content="BARBRICKDESIGN - Elite Web3 Hub">
    <meta property="og:description" content="Cutting-edge Web3 development and design solutions">
    <meta property="og:image" content="https://barbrickdesign.github.io/header.jpg">
    <meta name="description" content="BARBRICKDESIGN - Elite Web3 Development and Design Hub">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Wallet - Gem Bot Universe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 70px 0 0 0; /* Increased top padding from 60px to 70px */
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 600% 600%;
            animation: gradient 15s ease infinite;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh; /* Changed from height to min-height for better responsiveness */
            text-align: center;
        }

        @keyframes gradient {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }

        .auth-container {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 10px;
            width: 350px;
            max-width: 90%;
        }

        h1 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        input[type="email"], 
        input[type="password"],
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        input[type="email"]:focus, 
        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.2);
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background-color: #2196f3;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0d8aee;
        }

        .switch-form {
            margin-top: 20px;
            font-size: 14px;
            color: #ccc;
        }

        .switch-form a {
            color: #2196f3;
            text-decoration: none;
        }

        .phantom-btn {
            background-color: #8a2be2;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phantom-btn img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }

        .back-home {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            z-index: 100;
        }

        .back-home:before {
            content: '‚Üê';
            margin-right: 5px;
            font-size: 20px;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(34, 34, 34, 0.9);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-home">Back to Home</a>
    <div class="status-indicator" id="serverStatus">Server: ...</div>
    
    <div class="auth-container" id="wallet-connect-form">
        <h1>üîå Connect Your Wallet</h1>
        <p style="color: #ccc; margin-bottom: 25px; line-height: 1.6;">
            Connect your crypto wallet to access Gem Bot Universe.<br>
            No email or password needed - just your wallet!
        </p>
        
        <button type="button" id="metamask-connect" style="background: linear-gradient(90deg, #ff6b35, #f7931e); margin-bottom: 15px;">
            ü¶ä Connect MetaMask
        </button>
        
        <button type="button" id="phantom-connect" class="phantom-btn">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MCA1MCI+PHRpdGxlPnBoYW50b20tZmF2aWNvbi0yPC90aXRsZT48cGF0aCBkPSJNMjUsMEM0MC41MDc4LDAsMzAuNDQzOCwwLDQ2LjY5MjksMy4wOTI0YzAsMCw0Ljg0ODgsMTEuMzQ3MS00Ljg0ODgsMTkuMDA3MUMyOS42OCwyOC43NTI5LDI2LjU1NzYsMjMuNzY0NywyNSwyMi4xMzY1VjE2LjYxMThjOC4yNjEyLDEuMjM1MywzLjQxMTgtNy4wNywyLjIyMzUtOS4yOTQxSDI1VjBaIiBmaWxsPSIjZmZmIi8+PHBhdGggZD0iTTI1LDQ3LjExNzZjLTE1LjUwNzgsMC01LjQ0MzgsMC0yMS42OTI5LTMuMDkyNEMzLjMwNzEsMzIuNjc1OSw4LjE1NTksMzMuNzE3Niw4LjE1NTksMjQgYzAtOS43MTc2LTQuODQ4OC04LjY3NTktNC44NDg4LTE5LjQzNThDMzQuMDIxMSwwLDI1LDAsMjUsMHY3LjMxNzZoLTIuMjIzNUM4LjczODMsNC44NzA2LDE2Ljc4MzIsMTIuMzUyOSwyNSwxNC4wMjM1djYuNDg1M2MtMTcuMjQsMC43Niw2LjEzODMsMjYuNjA5NC0zLjMwNzEsMjYuNjA5NEgyNXY3LjMxNzZaIiBmaWxsPSIjZmZmIi8+PHBhdGggZD0iTTI1LDQ3LjExNzZjLTE1LjUwNzgsMC01LjQ0MzgsMC0yMS42OTI5LTMuMDkyNEMzLjMwNzEsMzIuNjc1OSw4LjE1NTksMzMuNzE3Niw4LjE1NTksMjQgYzAtOS43MTc2LTQuODQ4OC04LjY3NTktNC44NDg4LTE5LjQzNThDMzQuMDIxMSwwLDI1LDAsMjUsMHY3LjMxNzZoLTIuMjIzNUM4LjczODMsNC44NzA2LDE2Ljc4MzIsMTIuMzUyOSwyNSwxNC4wMjM1djYuNDg1M2MtMTcuMjQsMC43Niw2LjEzODMsMjYuNjA5NC0zLjMwNzEsMjYuNjA5NEgyNXY3LjMxNzZaIiBmaWxsPSIjZmZmIi8+PC9zdmc+" alt="Phantom" loading="lazy">
            üëª Connect Phantom
        </button>
        
        <div style="margin-top: 25px; padding: 20px; background: rgba(0,255,153,0.1); border: 1px solid rgba(0,255,153,0.3); border-radius: 8px;">
            <p style="color: #00ff99; font-size: 14px; margin: 0;">
                ‚úÖ <strong>Secure</strong> - Your wallet, your keys<br>
                ‚úÖ <strong>Fast</strong> - Instant authentication<br>
                ‚úÖ <strong>Simple</strong> - No passwords to remember
            </p>
        </div>
    </div>

    <div id="debug-panel" style="display:none; background:rgba(0,0,0,0.7); color:#fff; margin:20px auto 0 auto; padding:16px; border-radius:8px; max-width:400px; font-size:13px;">
        <b>Debug Panel</b>
        <div><b>currentUser:</b> <pre id="debug-currentUser" style="white-space:pre-wrap;word-break:break-all;"></pre></div>
        <div><b>userProfile:</b> <pre id="debug-userProfile" style="white-space:pre-wrap;word-break:break-all;"></pre></div>
        <div><b>lastWalletAuth:</b> <span id="debug-lastWalletAuth"></span></div>
        <div><b>Phantom Debug Log:</b> <pre id="debug-phantomLog" style="white-space:pre-wrap;word-break:break-all;max-height:120px;overflow:auto;background:rgba(255,255,255,0.05);padding:6px;border-radius:5px;"></pre></div>
        <button id="debug-refresh" style="margin-top:8px;">Refresh Debug Data</button>
        <hr style="margin:12px 0; border:0; border-top:1px solid #444;">
        <div id="all-users-panel">
            <b>All Users</b>
            <div id="all-users-list" style="margin-top:8px; max-height:200px; overflow:auto;"></div>
        </div>
    </div>

    <!-- Removed signup form - wallet connection handles everything -->

    <!-- Transaction UI for authenticated users -->
    <div class="auth-container" id="transaction-section" style="display:none; margin-top: 30px;">
        <h1>MGC Wallet & In-Game Balance</h1>
        <div class="form-group">
            <label>Wallet Address:</label>
            <span id="wallet-address-display"></span>
        </div>
        <div class="form-group">
            <label>Wallet MGC Balance:</label>
            <span id="wallet-mgc-balance">-</span>
        </div>
        <div class="form-group">
            <label>In-Game MGC Balance:</label>
            <span id="ingame-mgc-balance">-</span>
        </div>
        <div class="form-group">
            <label for="deposit-amount">Deposit MGC to In-Game</label>
            <input type="number" id="deposit-amount" min="1" placeholder="Amount to deposit">
            <button type="button" id="deposit-btn">Deposit</button>
        </div>
        <div class="form-group">
            <label for="withdraw-amount">Withdraw MGC to Wallet</label>
            <input type="number" id="withdraw-amount" min="1" placeholder="Amount to withdraw">
            <button type="button" id="withdraw-btn">Request Withdraw</button>
        </div>
        <div class="form-group">
            <label>Transaction Log:</label>
            <ul id="transaction-log" style="max-height:120px;overflow:auto;background:rgba(255,255,255,0.05);padding:10px;border-radius:5px;"></ul>
        </div>
    </div>

    <!-- Universal Wallet Authentication System -->
    <script src="../../contractor-registry.js" defer></script>
    <script src="../../universal-wallet-auth.js" defer></script>
    <script src="../../auth-integration.js" defer></script>
    
    <!-- Solana web3.js and SPL Token for blockchain functionality -->
    <script src="https://unpkg.com/@solana/web3.js@1.95.2/lib/index.iife.js" defer></script>
    <script src="https://unpkg.com/@solana/spl-token@0.3.10/lib/index.iife.js" defer></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize universal auth
            try {
                await window.authIntegration.init({
                    showUI: false,  // Custom UI
                    onAuthSuccess: (authInfo) => {
                        // Redirect to referring page or index
                        const redirectUrl = localStorage.getItem('authRedirect') || document.referrer || 'index.html';
                        localStorage.removeItem('authRedirect');
                        window.location.href = redirectUrl.includes('login.html') ? 'index.html' : redirectUrl;
                    }
                });
            } catch (error) {
                console.error('‚ùå Auth init failed:', error);
            }
            
            // MetaMask Connect
            document.getElementById('metamask-connect').addEventListener('click', async () => {
                const btn = document.getElementById('metamask-connect');
                btn.disabled = true;
                btn.textContent = '‚è≥ Connecting...';
                
                try {
                    const authInfo = await window.universalWalletAuth.connect();
                    
                    if (authInfo) {
                        // Redirect
                        const redirectUrl = localStorage.getItem('authRedirect') || document.referrer || 'index.html';
                        localStorage.removeItem('authRedirect');
                        window.location.href = redirectUrl.includes('login.html') ? 'index.html' : redirectUrl;
                    } else {
                        throw new Error('Connection failed');
                    }
                } catch (error) {
                    console.error('‚ùå MetaMask connection error:', error);
                    alert('MetaMask connection failed: ' + error.message);
                    btn.disabled = false;
                    btn.textContent = 'ü¶ä Connect MetaMask';
                }
            });

            // Phantom Connect
            document.getElementById('phantom-connect').addEventListener('click', async () => {
                const btn = document.getElementById('phantom-connect');
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Connecting...';
                
                try {
                    const authInfo = await window.universalWalletAuth.connect();
                    
                    if (authInfo) {
                        // Redirect
                        const redirectUrl = localStorage.getItem('authRedirect') || document.referrer || 'index.html';
                        localStorage.removeItem('authRedirect');
                        window.location.href = redirectUrl.includes('login.html') ? 'index.html' : redirectUrl;
                    } else {
                        throw new Error('Connection failed');
                    }
                } catch (error) {
                    console.error('‚ùå Phantom connection error:', error);
                    alert('Phantom connection failed: ' + error.message);
                    btn.disabled = false;
                    btn.innerHTML = '<img src="..." alt="Phantom" loading="lazy">üëª Connect Phantom';
                }
            });
            
            // OLD email/password code removed - using wallet-only authentication now
            });

        function showTransactionSection() {
            const walletForm = document.getElementById('wallet-connect-form');
            if (walletForm) walletForm.style.display = 'none';
            document.getElementById('transaction-section').style.display = 'block';
            updateBalancesAndLog();
        }

        async function updateBalancesAndLog() {
            // Get user info
            let user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            let profile = JSON.parse(localStorage.getItem('userProfile') || 'null');
            if (!user || !profile) return;
            document.getElementById('wallet-address-display').textContent = user.walletAddress || '-';
            // Get wallet MGC balance (async)
            if (window.getMGCBalance && user.walletAddress) {
                document.getElementById('wallet-mgc-balance').textContent = 'Loading...';
                let bal = await window.getMGCBalance(user.walletAddress);
                document.getElementById('wallet-mgc-balance').textContent = bal;
            } else {
                document.getElementById('wallet-mgc-balance').textContent = profile.mgcBalance || 0;
            }
            document.getElementById('ingame-mgc-balance').textContent = profile.inGameMGC || 0;
            // Transaction log
            let txLog = JSON.parse(localStorage.getItem('transactionLog') || '[]');
            let logHtml = txLog.slice(-10).reverse().map(tx => `<li><b>${tx.type}</b>: ${tx.details.amount || ''} ${tx.details.txid ? `<a href='https://solscan.io/tx/${tx.details.txid}' target='_blank'>TX</a>` : ''} <span style='font-size:10px;color:#aaa;'>${tx.timestamp}</span></li>`).join('');
            document.getElementById('transaction-log').innerHTML = logHtml;
        }

        // Deposit button
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('deposit-btn').addEventListener('click', async () => {
                let amt = parseFloat(document.getElementById('deposit-amount').value);
                if (window.depositMGC && amt > 0) {
                    await window.depositMGC(amt);
                    updateBalancesAndLog();
                }
            });
            document.getElementById('withdraw-btn').addEventListener('click', async () => {
                let amt = parseFloat(document.getElementById('withdraw-amount').value);
                if (window.withdrawMGC && amt > 0) {
                    await window.withdrawMGC(amt);
                    updateBalancesAndLog();
                }
            });
        });

        // Show transaction section if logged in (but don't auto-redirect)
        document.addEventListener('DOMContentLoaded', () => {
            let user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (user && user.walletAddress) {
                // Check if they want to see wallet management
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('wallet') === 'true') {
                    showTransactionSection();
                }
            }
        });

        function updateDebugPanel() {
            const cu = localStorage.getItem('currentUser');
            const up = localStorage.getItem('userProfile');
            const lwa = localStorage.getItem('lastWalletAuth');
            document.getElementById('debug-currentUser').textContent = cu || 'null';
            document.getElementById('debug-userProfile').textContent = up || 'null';
            document.getElementById('debug-lastWalletAuth').textContent = lwa || 'null';
            // Add Phantom debug log
            let phantomLog = [];
            try {
                phantomLog = JSON.parse(localStorage.getItem('wallet_debug_logs') || '[]');
            } catch (e) {}
            if (phantomLog && phantomLog.length) {
                document.getElementById('debug-phantomLog').textContent = phantomLog.slice(-10).map(l => `[${l.timestamp}] ${l.context}: ${l.message}${l.data ? ' | ' + l.data : ''}`).join('\n');
            } else {
                document.getElementById('debug-phantomLog').textContent = 'No logs.';
            }
        }
        document.getElementById('debug-refresh').onclick = updateDebugPanel;
        // Show debug panel for devs
        document.getElementById('debug-panel').style.display = 'block';
        updateDebugPanel();

        // --- All Users Panel Logic ---
        async function fetchAndDisplayAllUsers() {
            const usersListDiv = document.getElementById('all-users-list');
            usersListDiv.innerHTML = 'Loading...';
            try {
                const res = await fetch('/api/users');
                if (!res.ok) throw new Error('Failed to fetch users');
                const users = await res.json();
                if (!Array.isArray(users) || users.length === 0) {
                    usersListDiv.innerHTML = '<i>No users found.</i>';
                    return;
                }
                usersListDiv.innerHTML = users.map(user => {
                    const isLoggedIn = user.isLoggedIn || false;
                    const color = isLoggedIn ? '#2ecc40' : '#ff4136';
                    const joinDate = user.joinDate ? new Date(user.joinDate).toLocaleString() : '-';
                    const stats = user.stats ? JSON.stringify(user.stats) : '';
                    const displayName = user.displayName || user.username || user.email || user.walletAddress || 'User';
                    const profileUrl = `profile.html?user=${encodeURIComponent(user.username || user.email || user.walletAddress || '')}`;
                    return `<div style="border-left:6px solid ${color};padding:6px 0 6px 8px;margin-bottom:6px;background:rgba(255,255,255,0.04);border-radius:4px;">
                        <a href="${profileUrl}" style="color:${color};font-weight:bold;text-decoration:underline;cursor:pointer;">${displayName}</a>
                        <div style="font-size:12px;color:#ccc;">Status: <span style="color:${color};font-weight:bold;">${isLoggedIn ? 'Online' : 'Offline'}</span></div>
                        <div style="font-size:12px;color:#ccc;">Joined: ${joinDate}</div>
                        <div style="font-size:12px;color:#ccc;">Stats: ${stats}</div>
                    </div>`;
                }).join('');
            } catch (e) {
                usersListDiv.innerHTML = '<span style="color:#ff4136">Error loading users.</span>';
            }
        }
        // Call on load and on debug refresh
        fetchAndDisplayAllUsers();
        document.getElementById('debug-refresh').addEventListener('click', fetchAndDisplayAllUsers);
    </script>
    <script>
        );
        );
        );
        );
        
        // Server status indicator (graceful failure)
        async function updateServerStatus() {
            const statusEl = document.getElementById('serverStatus');
            if (!statusEl) return;
            
            try {
                const res = await fetch('/api/ping', { cache: 'no-store', signal: AbortSignal.timeout(2000) });
                if (res.ok) {
                    statusEl.textContent = 'Server: ‚úì Online';
                    statusEl.style.background = 'rgba(0, 200, 0, 0.8)';
                    statusEl.style.display = 'block';
                } else {
                    statusEl.style.display = 'none';
                }
            } catch (e) {
                // Server offline is normal - hide to avoid clutter
                statusEl.style.display = 'none';
            }
        }
        updateServerStatus();
        setInterval(updateServerStatus, 10000);
    </script>
</body>
</html>