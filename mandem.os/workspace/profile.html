<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Gem Bot Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 70px 0 0 0;
            background: linear-gradient(135deg, #1a2a6c, #069901, #0313f5);
            background-size: 600% 600%;
            animation: gradient 15s ease infinite;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }
        @keyframes gradient {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }
        .profile-container {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 10px;
            width: 400px;
            max-width: 95%;
            margin-top: 40px;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        .profile-row {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        input[type="number"]:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.2);
        }
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background-color: #2196f3;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0d8aee;
        }
        .phantom-btn {
            background-color: #8a2be2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .phantom-btn img {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }
        .transaction-log {
            max-height: 120px;
            overflow: auto;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 5px;
            text-align: left;
        }
        .back-home {
            position: absolute;
            top: 90px;
            left: 20px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            z-index: 100;
        }
        .back-home:before {
            content: '‚Üê';
            margin-right: 5px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-home">Back to Home</a>
    <div class="profile-container" id="profile-section">
        <h1>User Profile</h1>
        <div class="profile-row"><label>Display Name:</label> <input type="text" id="profile-display-name-input" style="width:70%"><button id="save-display-name" style="width:auto;margin-left:8px;">Save</button></div>
        <div class="profile-row"><label>Email:</label> <input type="email" id="profile-email-input" style="width:70%"><button id="save-email" style="width:auto;margin-left:8px;">Save</button></div>
        <div class="profile-row"><label>Connected Wallets:</label> <ul id="profile-wallet-list"></ul><button id="connect-another-wallet-btn" style="width:auto;margin-top:8px;">Connect Another Wallet</button></div>
        <div class="profile-row"><label>Primary Wallet Address:</label> <span id="profile-wallet-address"></span></div>
        <div class="profile-row"><label>Wallet MGC Balance:</label> <span id="profile-wallet-mgc">-</span></div>
        <div class="profile-row"><label>In-Game MGC Balance:</label> <span id="profile-ingame-mgc">-</span></div>
        <div class="profile-row"><label>Total MGC Balance:</label> <span id="profile-total-mgc">-</span></div>
        <div class="profile-row">
            <label for="profile-deposit-amount">Deposit MGC to In-Game</label>
            <input type="number" id="profile-deposit-amount" min="1" placeholder="Amount to deposit">
            <button type="button" id="profile-deposit-btn">Deposit</button>
        </div>
        <div class="profile-row">
            <label for="profile-withdraw-amount">Withdraw MGC to Wallet</label>
            <input type="number" id="profile-withdraw-amount" min="1" placeholder="Amount to withdraw">
            <button type="button" id="profile-withdraw-btn">Request Withdraw</button>
        </div>
        <div class="profile-row">
            <label>Transaction Log:</label>
            <ul id="profile-transaction-log" class="transaction-log"></ul>
        </div>
        <div class="profile-row">
            <label>Travel & Leaderboard Stats:</label>
            <div id="leaderboard-stats">
                <div>Total Distance: <span id="stat-distance">0</span> meters</div>
                <div>Uptime: <span id="stat-uptime">0</span> seconds</div>
                <div>Last Sync: <span id="stat-last-sync">-</span></div>
                <div>Recent Locations:</div>
                <ul id="stat-travel-log" style="max-height:60px;overflow:auto;font-size:12px;"></ul>
            </div>
        </div>
        <div class="profile-row">
            <button id="logout-btn" style="background-color:#f44336;margin-top:20px;">Log Out</button>
        </div>
    </div>
    <section id="userForgedAssets" style="margin:2em 0;">
      <h2>My Forged Assets</h2>
      <div id="forgedAssetsGrid" style="display:flex;flex-wrap:wrap;gap:18px;"></div>
    </section>
    <div id="debug-log" style="background:rgba(0,0,0,0.8);color:#fff;padding:10px;margin:10px 0 20px 0;border-radius:6px;font-size:13px;max-width:600px;word-break:break-all;display:block;min-height:40px;">Debug log area loaded. Waiting for script...</div>
    <!-- Solana web3.js and SPL Token for blockchain functionality -->
    <script src="https://unpkg.com/@solana/web3.js@1.95.2/lib/index.iife.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@0.3.10/lib/index.iife.js"></script>
    <!-- Include auth.js for wallet and MGC logic -->
    <script src="./src/auth.js"></script>
    <script src="/WorkingProject/profile.js"></script>
    <script src="public/phantomLogin.js"></script>
    <script>
    function showDebugLog(msg) {
        var logDiv = document.getElementById('debug-log');
        logDiv.style.display = 'block';
        logDiv.textContent += (msg + '\n');
    }
    console.log('[DEBUG] profile.html loaded');
    console.log('[DEBUG] currentUser:', localStorage.getItem('currentUser'));
    console.log('[DEBUG] userProfile:', localStorage.getItem('userProfile'));
    console.log('[DEBUG] userLoggedIn:', localStorage.getItem('userLoggedIn'));
    console.log('[DEBUG] lastWalletAuth:', localStorage.getItem('lastWalletAuth'));

    // Utility: Clear session/localStorage for debugging
    function clearSessionAndReload() {
      localStorage.clear();
      sessionStorage.clear();
      location.reload();
    }
    // Add a button for devs
    const debugLogDiv = document.getElementById('debug-log');
    if (debugLogDiv) {
      const btn = document.createElement('button');
      btn.textContent = 'Clear Session & Reload';
      btn.style.margin = '10px 0';
      btn.onclick = clearSessionAndReload;
      debugLogDiv.parentNode.insertBefore(btn, debugLogDiv);
    }

    // Check for valid login/session data
    function isUserAuthenticated() {
      try {
        const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
        const lastAuth = localStorage.getItem('lastWalletAuth');
        if (!user || !user.walletAddress || !lastAuth) return false;
        const lastAuthTime = new Date(lastAuth).getTime();
        const now = Date.now();
        return (now - lastAuthTime) < 86400000;
      } catch (e) {
        return false;
      }
    }

    // Check server connectivity before loading user data
    async function checkServerConnection() {
      try {
        const res = await fetch('/api/ping', { cache: 'no-store' });
        if (!res.ok) throw new Error('Server not reachable');
        return true;
      } catch (e) {
        return false;
      }
    }

    (async function() {
      if (!isUserAuthenticated()) {
        document.body.innerHTML = '<div style="margin:40px auto;max-width:400px;padding:32px;background:#222;color:#fff;border-radius:10px;text-align:center;">'+
          '<h2>Not logged in</h2><p>Your session has expired or you are not logged in.<br><a href="login.html" style="color:#0ff;text-decoration:underline;">Go to Login</a></p></div>';
        return;
      }
      const serverOk = await checkServerConnection();
      if (!serverOk) {
        document.body.innerHTML = '<div style="margin:40px auto;max-width:400px;padding:32px;background:#222;color:#fff;border-radius:10px;text-align:center;">'+
          '<h2>Server Offline</h2><p>Cannot connect to the server. Please try again later.<br><button onclick="location.reload()" style="margin-top:12px;">Retry</button></p></div>';
        return;
      }
      // ...existing code to load/display user data...
    })();
    </script>
</body>
</html>
