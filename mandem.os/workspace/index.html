<!DOCTYPE html> 
<html lang="en"> 
    <head> 
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"> 
        <title>Gem Bot Universe for this project by Ryan Barbrick. of BarbrickDesign.com</title>         
        <link href="css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="public/styles.css"> 
        <!-- Link to the manifest -->         
        <link rel="manifest" href="../../manifest.json"> 
        <!-- Set theme color -->         
        <meta name="theme-color" content="#0ff"> 
        <!-- Apple Touch Icon -->         
        <link rel="apple-touch-icon" href="public/apple-touch-icon.png"> 
        <!-- Import Orbitron font -->         
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"> 
        <style>
/* Modal styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
.modal-content {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  padding: 30px;
  border-radius: 16px;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0, 255, 153, 0.3);
  border: 2px solid #00ff99;
  text-align: center;
}
.modal-content h3 {
  margin: 0 0 15px 0;
  color: #00ff99;
  font-size: 24px;
}
.modal-content p {
  margin: 0 0 20px 0;
  color: #ccc;
  line-height: 1.6;
}
.modal-content .auth-button {
  margin: 8px;
  min-width: 140px;
}
/* Move login button to bottom left on mobile */
@media (max-width: 700px) {
  #loginBtn {
    position: fixed !important;
    left: 18px;
    bottom: 18px;
    z-index: 1200;
    margin: 0 !important;
    width: auto;
    min-width: 90px;
    border-radius: 8px;
    box-shadow: 0 2px 8px #0002;
  }
  #profileBtn {
    position: fixed !important;
    left: 18px;
    bottom: 18px;
    z-index: 1200;
    margin: 0 !important;
    width: auto;
    min-width: 90px;
    border-radius: 8px;
    box-shadow: 0 2px 8px #0002;
  }
}
/* Mobile table scroll */
@media (max-width: 700px) {
  table, .stat-table {
    display: block;
    overflow-x: auto;
    width: 100%;
    max-width: 100vw;
  }
  th, td {
    min-width: 90px;
    font-size: 15px;
  }
  .profile-card, .container, .post-login-content {
    padding: 8px !important;
  }
}
/* Larger touch targets for mobile */
@media (max-width: 700px) {
  button, .auth-button {
    min-height: 44px;
    font-size: 18px;
  }
}

/* Ensure 3D globe is always visible */
#globe-container {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 1 !important;
  display: block !important;
}
</style>
    
    <!-- Universal Wallet Authentication System -->
    <script src="../../src/core/contractor-registry.js"></script>
    <script src="../../src/core/universal-wallet-auth.js"></script>
    <script src="../../src/core/auth-integration.js"></script>

    <!-- Shared Systems -->
    <script src="../../src/utils/shared-utilities.js"></script>
    <script src="../../src/utils/shared-wallet-system.js"></script>
    </head>     
    <body> 
        <header>
            <div class="header-left">
                <button id="contentToggleBtn" class="content-toggle-button">Mission Control</button>
            </div>
            <h1>Gem Bot Universe</h1>
            <p class="header-desc">by Ryan Barbrick ¬∑ BarbrickDesign.com<br>Explore our virtual environments and trading systems.</p>
            <div class="auth-links-header" id="authLinksHeader" style="margin-top:1em; text-align:center;">
                <a class="auth-button" id="loginBtn" style="display: inline-block;">Log In</a>
                <a href="profile.html" class="auth-button" id="profileBtn" style="display:none;">Profile</a>
            </div>
        </header>         
        <!-- Fullscreen 3D globe container -->
        <div id="globe-container" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; display: block;">
            <!-- 3D Globe will be rendered here by Three.js -->
        </div>

        <!-- Welcome overlay - hide immediately -->
        <div class="welcome-overlay" style="display: none !important;">
            <h2>Gem Bot Universe</h2>
            <p>Explore our interactive 3D environments and trading systems by navigating the Globe Interface. Access the Laboratory for research, Warehouse for storage, Explorer for real-world navigation, and Grand Exchange for trading.</p>

            <!-- Feature overview -->
            <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üè≠</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Laboratory</div>
                    <div style="font-size: 12px; opacity: 0.8;">Research & development</div>
                </div>
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üèóÔ∏è</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Warehouse</div>
                    <div style="font-size: 12px; opacity: 0.8;">Storage & inventory</div>
                </div>
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üó∫Ô∏è</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Explorer</div>
                    <div style="font-size: 12px; opacity: 0.8;">Real-world navigation</div>
                </div>
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">‚öîÔ∏è</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Grand Exchange</div>
                    <div style="font-size: 12px; opacity: 0.8;">Trading & marketplace</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="hideWelcomeOverlay()" style="
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                ">‚ú® Enter Gem Bot Universe</button>
            </div>
        </div>         
        <!-- Post-login content (initially hidden) -->         
        <div class="post-login-content" id="postLoginContent" style="display:none;">
            <section id="labControls">
                <h2>Gem Bot Universe Control Center</h2>
                <p>Access and manage your Gem Bot systems:</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <button id="launchLabBtn" style="background: linear-gradient(135deg, #00ff99, #00cc66); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        üè≠ Launch Laboratory<br><small>Research & Development</small>
                    </button>

                    <button id="launchWarehouseBtn" style="background: linear-gradient(135deg, #ffaa00, #ff8800); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        üèóÔ∏è Access Warehouse<br><small>Storage & Inventory</small>
                    </button>

                    <button id="launchExplorerBtn" style="background: linear-gradient(135deg, #66ff99, #00ff88); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        üó∫Ô∏è Start Explorer<br><small>Real-world Navigation</small>
                    </button>

                    <button id="launchExchangeBtn" style="background: linear-gradient(135deg, #ffd700, #ffb300); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        ‚öîÔ∏è Enter Grand Exchange<br><small>Trading & Marketplace</small>
                    </button>
                </div>

                <button id="checkConnectionBtn" style="background: #2196f3; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 10px;">
                    üîó Check System Status
                </button>

                <button id="syncSettingsBtn" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 10px;">
                    üîÑ Sync Settings
                </button>
            </section>
        </div>         </div>

        <!-- Agent/Tester Log Panel -->
        <div class="profile-card" id="agentLogPanel" style="display:none;">
            <h2>System Activity Monitor</h2>
            <p>Real-time monitoring of Gem Bot Universe systems and components.</p>
            <button id="toggleAgentLog" class="auth-button" style="margin-top: 10px;">Hide Monitor</button>
        </div>

        <!-- Move All Players button to bottom right, left of chat -->
        <button id="showAgentLogBtn" class="auth-button all-players-bottom-btn" style="display:none;">System Monitor</button>
        <!-- Login Check Modal (Now non-blocking) -->         
        <div id="loginModal" class="modal" style="display:none"> 
            <div class="modal-content"> 
                <h3>Enhanced Features Available</h3> 
                <p>Connect your wallet to access advanced features like live feeds, MGC balance tracking, and exclusive 3D environments.</p> 
                <button id="modalLoginBtn" class="auth-button">Connect Wallet</button>                 
                <button id="modalCloseBtn" class="auth-button">Continue Without Login</button>                 
            </div>             
        </div>         
        <footer> 
            <p>&copy; 2025 Gem Bot Project | All Rights Reserved</p> 
        </footer>         
        <!-- Load JavaScript files -->         
        <!-- Solana Wallet Integration -->
        <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.8/lib/index.iife.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
        <script src="public/phantomLogin.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>         
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>         
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>         
        <!-- New globe script -->         
        <script>
    // Check if the user is logged in
    function isUserLoggedIn() {
      // Check for both authentication methods to ensure compatibility
      return localStorage.getItem('currentUser') !== null || localStorage.getItem('userLoggedIn') === 'true';
    }

    // Wallet-based authentication check (same as profile.js)
    function isUserAuthenticated() {
      const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
      const lastAuth = localStorage.getItem('lastWalletAuth');
      if (!user || !user.walletAddress || !lastAuth) return false;
      const lastAuthTime = new Date(lastAuth).getTime();
      const now = Date.now();
      return (now - lastAuthTime) < 86400000;
    }

    function updateAuthButton() {
      const loginBtn = document.getElementById('loginBtn');
      const profileBtn = document.getElementById('profileBtn');
      if (isUserAuthenticated()) {
        loginBtn.style.display = 'none';
        profileBtn.style.display = 'inline-block';
        profileBtn.textContent = 'Profile';
        profileBtn.href = 'profile.html';
      } else {
        loginBtn.style.display = 'inline-block';
        loginBtn.textContent = 'Log In';
        profileBtn.style.display = 'none';
      }
    }

    // Show login modal (optional, non-blocking)
    function showLoginModal() {
      const modal = document.getElementById('loginModal');
      if (modal) {
        modal.style.display = 'flex';
      }
    }
    
    // Update UI based on login state (non-blocking)
    function updateUIForLoginState() {
      const isLoggedIn = isUserLoggedIn();
      const contentToggleBtn = document.getElementById('contentToggleBtn');
      const welcomeOverlay = document.querySelector('.welcome-overlay');
      
      // Always show content toggle for better UX
      if (contentToggleBtn) {
        contentToggleBtn.style.display = 'block';
      }
      
      // Hide welcome overlay after first visit or if logged in
      if (isLoggedIn || localStorage.getItem('visited')) {
        if (welcomeOverlay) welcomeOverlay.style.display = 'none';
      }
      
      // Mark as visited
      localStorage.setItem('visited', 'true');
    }
    
    // Enhanced wallet connection using shared wallet system
    async function connectWalletForMGC() {
      try {
        if (window.sharedWalletSystem) {
          await window.sharedWalletSystem.connect();
          console.log('‚úÖ Wallet connected via shared system');
          updateAuthButton();
          updateMgcBalanceDisplay();
          return true;
        }

        // Fallback to old system if shared system not available
        return await quickConnectWallet();
      } catch (error) {
        console.error('‚ùå Wallet connection failed:', error);
        alert('Wallet connection failed. Please try again.');
        return false;
      }
    }
    
    // Fallback wallet connection for backward compatibility
    async function quickConnectWallet() {
      try {
        const provider = window.solana;
        if (!provider || !provider.isPhantom) {
          alert('Phantom wallet not found. Please install Phantom browser extension.');
          window.open('https://phantom.app/', '_blank');
          return false;
        }
        
        const resp = await provider.connect();
        const publicKey = resp.publicKey.toBase58();
        
        // Store basic auth info
        const user = {
          walletAddress: publicKey,
          displayName: `User ${publicKey.slice(0, 4)}...${publicKey.slice(-4)}`,
          joinDate: new Date().toISOString()
        };
        
        localStorage.setItem('currentUser', JSON.stringify(user));
        localStorage.setItem('userLoggedIn', 'true');
        localStorage.setItem('lastWalletAuth', new Date().toISOString());
        
        // Update UI
        updateAuthButton();
        updateMgcBalanceDisplay();
        
        console.log('[Auth] Wallet connected:', publicKey);
        return true;
      } catch (err) {
        console.error('[Auth] Connection failed:', err);
        alert('Wallet connection failed. Please try again.');
        return false;
      }
    }
    
    // Soft auth check (suggest login but don't block)
    function enforceAuthNavigation() {
      const protectedPages = [
        'profile.html', 'admin-forge.html'
      ];
      const openPage = window.location.pathname.split('/').pop();
      if (protectedPages.includes(openPage) && !isUserAuthenticated()) {
        // login.html is broken, just show alert instead
        alert('Please connect your wallet to access this page.');
        // Optionally redirect back to index
        window.location.href = 'index.html';
      }
      // Other pages are accessible without login but show login prompt
    }

    // Show MGC balance if user is logged in
    function showMgcBalance(balance) {
      const mgcDiv = document.getElementById('mgcBalanceDisplay');
      const mgcSpan = document.getElementById('mgcBalance');
      if (mgcDiv && mgcSpan) {
        mgcDiv.style.display = 'block';
        mgcSpan.textContent = balance;
      }
    }
    
    // Simulate fetching MGC balance for the logged-in user
    function fetchMgcBalance() {
      // TODO: Replace with real API call to fetch MGC balance from Solana/Phantom wallet
      // For now, simulate with a random value
      return new Promise(resolve => {
        setTimeout(() => {
          const fakeBalance = (Math.random() * 1000).toFixed(2);
          resolve(fakeBalance);
        }, 600);
      });
    }
    
    function updateMgcBalanceDisplay() {
      const mgcDiv = document.getElementById('mgcBalanceDisplay');
      const mgcSpan = document.getElementById('mgcBalance');
      const displayMgcSpan = document.getElementById('displayMgcBalance');
      
      if (!isUserAuthenticated()) {
        if (mgcDiv) mgcDiv.style.display = 'none';
        if (displayMgcSpan) displayMgcSpan.textContent = '0.00';
        return;
      }
      
      if (mgcDiv) mgcDiv.style.display = 'block';
      // Get balance from localStorage (real-time in-game MGC)
      let profile = JSON.parse(localStorage.getItem('userProfile') || 'null');
      let balance = profile && profile.inGameMGC ? profile.inGameMGC : 0;
      
      if (mgcSpan) mgcSpan.textContent = balance.toFixed ? balance.toFixed(2) : balance;
      if (displayMgcSpan) displayMgcSpan.textContent = balance.toFixed ? balance.toFixed(2) : balance;
    }

    // Toggle the post-login content
    function toggleControls() {
      const postLoginContent = document.getElementById('postLoginContent');
      const toggleBtn = document.getElementById('contentToggleBtn');
      if (postLoginContent.style.display === 'block') {
        postLoginContent.style.display = 'none';
        toggleBtn.textContent = 'Mission Control';
        console.log('Mission Control hidden');
      } else {
        postLoginContent.style.display = 'block';
        toggleBtn.textContent = 'Hide Mission Control';
        console.log('Mission Control shown');
      }
    }
    
    // Add click handler for MGC balance link to go to profile
    const mgcLink = document.getElementById('mgcBalanceLink');
    if (mgcLink) {
      mgcLink.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'profile.html';
      });
    }

    // Update UI based on login state
    updateUIForLoginState();

    // Show MGC balance if logged in
    if (isUserLoggedIn()) {
      fetchMgcBalance().then(showMgcBalance);
    }

    // Update auth buttons
    updateAuthButton(); // Ensure button is correct on page load
    enforceAuthNavigation();

    // Update profileBtn click to show alert if not authenticated (login.html is broken)
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn) {
        profileBtn.addEventListener('click', function(e) {
            if (!isUserAuthenticated()) {
                e.preventDefault();
                alert('Please connect your wallet to access profile features.');
                return false;
            }
            // If authenticated, allow normal navigation to profile.html
        });
    }

    // Initialize 3D Globe immediately when page loads
    // This ensures the 3D scene renders before welcome overlay logic
    window.addEventListener('load', function() {
        console.log('üöÄ Initializing Gem Bot Universe 3D Scene...');

        // Hide welcome overlay immediately
        const welcomeOverlay = document.querySelector('.welcome-overlay');
        if (welcomeOverlay) {
            welcomeOverlay.style.display = 'none';
            console.log('‚úÖ Welcome overlay hidden immediately');
        }

        initGlobe();
    });

    // Also initialize on DOMContentLoaded as backup
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM ready, ensuring 3D scene...');
        if (!window.globeInitialized) {
            initGlobe();
        }

        // Setup welcome overlay hover disappear
        const welcomeOverlay = document.querySelector('.welcome-overlay');
        let hoverTimer;

        if (welcomeOverlay) {
            welcomeOverlay.addEventListener('mouseenter', function() {
                hoverTimer = setTimeout(function() {
                    welcomeOverlay.style.opacity = '0';
                    setTimeout(function() {
                        welcomeOverlay.style.display = 'none';
                    }, 1000);
                }, 2000);
            });

            welcomeOverlay.addEventListener('mouseleave', function() {
                clearTimeout(hoverTimer);
            });
        }

        // Setup modal buttons
        const modalLoginBtn = document.getElementById('modalLoginBtn');
        if (modalLoginBtn) {
            // Disabled - login.html is broken
            modalLoginBtn.style.display = 'none';
        }

        const modalCloseBtn = document.getElementById('modalCloseBtn');
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', function() {
                document.getElementById('loginModal').style.display = 'none';
            });
        }

        // Fix loginBtn to actually connect wallet
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            loginBtn.addEventListener('click', async function(e) {
                e.preventDefault();

                try {
                    console.log('üîê Connecting wallet...');
                    const success = await connectWalletForMGC();
                    if (success) {
                        console.log('‚úÖ Wallet connected successfully');
                        alert('Wallet connected successfully! You can now access all Gem Bot Universe features.');
                    } else {
                        console.log('‚ùå Wallet connection failed');
                        alert('Wallet connection failed. Please try again.');
                    }
                } catch (error) {
                    console.error('‚ùå Wallet connection error:', error);
                    alert('Wallet connection error: ' + error.message);
                }

                return false;
            });
        }

        // Setup content toggle button
        const contentToggleBtn = document.getElementById('contentToggleBtn');
        if (contentToggleBtn) {
            contentToggleBtn.addEventListener('click', toggleControls);
        }

        // Add click handlers for Mission Control buttons
        const launchLabBtn = document.getElementById('launchLabBtn');
        if (launchLabBtn) {
            launchLabBtn.addEventListener('click', function() {
                console.log('üè≠ Launching Laboratory...');
                window.location.href = 'laboratory.html';
            });
        }

        const launchWarehouseBtn = document.getElementById('launchWarehouseBtn');
        if (launchWarehouseBtn) {
            launchWarehouseBtn.addEventListener('click', function() {
                console.log('üèóÔ∏è Launching Warehouse...');
                window.location.href = 'warehouse.html';
            });
        }

        const launchExplorerBtn = document.getElementById('launchExplorerBtn');
        if (launchExplorerBtn) {
            launchExplorerBtn.addEventListener('click', function() {
                console.log('üó∫Ô∏è Launching Explorer...');
                window.location.href = 'outdoor.html';
            });
        }

        const launchExchangeBtn = document.getElementById('launchExchangeBtn');
        if (launchExchangeBtn) {
            launchExchangeBtn.addEventListener('click', function() {
                console.log('‚öîÔ∏è Launching Grand Exchange...');
                window.location.href = 'grand_exchange.html';
            });
        }

        // Check Connection and Sync Settings buttons (just show alerts for now)
        const checkConnectionBtn = document.getElementById('checkConnectionBtn');
        if (checkConnectionBtn) {
            checkConnectionBtn.addEventListener('click', function() {
                console.log('üîó Checking system connection...');
                alert('System Status: All systems operational!\n\n‚úÖ 3D Globe: Active\n‚úÖ Satellite Navigation: Active\n‚úÖ Wallet Integration: Connected\n‚úÖ Mission Control: Online');
            });
        }

        const syncSettingsBtn = document.getElementById('syncSettingsBtn');
        if (syncSettingsBtn) {
            syncSettingsBtn.addEventListener('click', function() {
                console.log('üîÑ Syncing settings...');
                alert('Settings synchronized successfully!\n\nüîÑ User preferences updated\nüîÑ 3D scene settings saved\nüîÑ Navigation history synced');
            });
        }

        // Update UI based on login state
        updateUIForLoginState();

        // Show MGC balance if logged in
        if (isUserLoggedIn()) {
            fetchMgcBalance().then(showMgcBalance);
        }

        // Update auth buttons
        updateAuthButton();
        enforceAuthNavigation();

        // Update profileBtn click to show alert if not authenticated (login.html is broken)
        const profileBtn = document.getElementById('profileBtn');
        if (profileBtn) {
            profileBtn.addEventListener('click', function(e) {
                if (!isUserAuthenticated()) {
                    e.preventDefault();
                    alert('Please connect your wallet to access profile features.');
                    return false;
                }
                // If authenticated, allow normal navigation to profile.html
            });
        }

        setInterval(updateMgcBalanceDisplay, 1000);
        updateMgcBalanceDisplay();
    }); 

    // Global satellites and labels arrays
    let satellites = [];
    let labels = [];

    // Clean, working 3D globe initialization
    function initGlobe() {
        console.log('üöÄ initGlobe() CALLED - Starting 3D initialization');

        // Prevent duplicate initialization
        if (window.globeInitialized) {
            console.log('‚úÖ Globe already initialized');
            return;
        }

        console.log('üåç Checking Three.js...');

        // Get container
        const container = document.getElementById('globe-container');
        if (!container) {
            console.error('‚ùå Globe container not found');
            return;
        }

        console.log('‚úÖ Container found:', container);

        // Check Three.js
        if (typeof THREE === 'undefined') {
            console.error('‚ùå Three.js not loaded, retrying...');
            setTimeout(initGlobe, 1000);
            return;
        }

        console.log('‚úÖ Three.js loaded, creating scene...');

        try {
            // Create scene, camera, renderer
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });

            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            console.log('‚úÖ 3D Scene created, adding Earth...');

            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 3, 5);
            scene.add(directionalLight);

            // Create Earth
            const earthGeometry = new THREE.SphereGeometry(5, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({
                transparent: true,
                opacity: 0.95
            });

            const earth = new THREE.Mesh(earthGeometry, earthMaterial);
            scene.add(earth);

            console.log('‚úÖ Earth created, loading texture...');

            // Load Earth texture
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load(
                'https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg',
                function(texture) {
                    console.log('‚úÖ Earth texture loaded successfully');
                    earthMaterial.map = texture;
                    earthMaterial.needsUpdate = true;
                },
                undefined,
                function(error) {
                    console.warn('‚ùå Earth texture failed, using blue:', error);
                    earthMaterial.color.setHex(0x0066ff);
                }
            );

            // Position camera
            camera.position.z = 15;

            // Add orbit controls
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            console.log('‚úÖ Controls added, starting animation...');

            // Add orbiting satellites with labels
            const environments = [
                { name: 'Grand Exchange', color: 0x3399ff, url: 'grand_exchange.html' },
                { name: 'Laboratory', color: 0x00cc66, url: 'laboratory.html' },
                { name: 'Warehouse', color: 0xffcc00, url: 'warehouse.html' },
                { name: 'Explorer', color: 0x66ff99, url: 'outdoor.html' },
            ];

            satellites = []; // Clear and repopulate global array
            labels = []; // Clear and repopulate global array

            environments.forEach((env, index) => {
                const angle = (index / environments.length) * Math.PI * 2;
                const radius = 11;

                const satelliteGeometry = new THREE.SphereGeometry(1, 16, 16);
                const satelliteMaterial = new THREE.MeshPhongMaterial({
                    color: env.color,
                    emissive: 0x000000, // Explicitly set emissive to black
                    shininess: 30
                });
                const satellite = new THREE.Mesh(satelliteGeometry, satelliteMaterial);

                satellite.position.x = Math.cos(angle) * radius;
                satellite.position.z = Math.sin(angle) * radius;
                satellite.position.y = 0; // Keep satellites at consistent height

                satellite.userData = {
                    name: env.name,
                    url: env.url,
                    originalEmissive: 0x000000 // Store original emissive color (black)
                };
                scene.add(satellite);
                satellites.push(satellite);

                // Create floating 3D text label
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 64;

                // Style the text
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(env.name, canvas.width / 2, canvas.height / 2);

                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture, transparent: true });
                const sprite = new THREE.Sprite(spriteMaterial);

                sprite.position.x = Math.cos(angle) * (radius + 1.5);
                sprite.position.z = Math.sin(angle) * (radius + 1.5);
                sprite.position.y = Math.sin(angle) * 2 + 1.2; // Lowered from +1.8 to +1.2 - directly above sphere
                sprite.scale.set(4, 1, 1);

                sprite.userData = { satellite: satellite };
                scene.add(sprite);
                labels.push(sprite);
            });
            // Mouse interaction setup
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            // Hover effect with debouncing
            let hoverTimeout;
            let lastHoveredSatellite = null;

            container.addEventListener('mousemove', function(event) {
                // Clear previous timeout
                if (hoverTimeout) clearTimeout(hoverTimeout);

                // Debounce mouse movements
                hoverTimeout = setTimeout(() => {
                    const rect = container.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects(satellites);

                    // Reset previously hovered satellite
                    if (lastHoveredSatellite && lastHoveredSatellite !== (intersects[0]?.object)) {
                        if (lastHoveredSatellite.material && lastHoveredSatellite.material.emissive) {
                            lastHoveredSatellite.material.emissive.setHex(lastHoveredSatellite.userData.originalEmissive);
                        }
                        lastHoveredSatellite = null;
                    }

                    // Reset all satellites to original state first
                    satellites.forEach(sat => {
                        if (sat.material && sat.material.emissive) {
                            sat.material.emissive.setHex(sat.userData.originalEmissive);
                        }
                    });

                    // Highlight currently hovered satellite
                    if (intersects.length > 0) {
                        const sat = intersects[0].object;
                        if (sat.material && sat.material.emissive) {
                            sat.material.emissive.setHex(0x444444); // Subtle gray highlight instead of white
                        }
                        container.style.cursor = 'pointer';
                        lastHoveredSatellite = sat;
                    } else {
                        container.style.cursor = 'default';
                        lastHoveredSatellite = null;
                    }
                }, 16); // ~60fps debounce
            });

            // Add touch controls for mobile
            let touchStartX = 0;
            let touchStartY = 0;
            let isDragging = false;

            container.addEventListener('touchstart', function(event) {
                if (event.touches.length === 1) {
                    touchStartX = event.touches[0].clientX;
                    touchStartY = event.touches[0].clientY;
                    isDragging = false;
                }
            });

            container.addEventListener('touchmove', function(event) {
                if (event.touches.length === 1) {
                    const deltaX = Math.abs(event.touches[0].clientX - touchStartX);
                    const deltaY = Math.abs(event.touches[0].clientY - touchStartY);

                    // If moved more than 10px, consider it a drag
                    if (deltaX > 10 || deltaY > 10) {
                        isDragging = true;
                    }
                }
            });

            container.addEventListener('touchend', function(event) {
                if (!isDragging && event.changedTouches.length === 1) {
                    // This was a tap/click, not a drag
                    const rect = container.getBoundingClientRect();
                    mouse.x = ((event.changedTouches[0].clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.changedTouches[0].clientY - rect.top) / rect.height) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects(satellites);

                    if (intersects.length > 0) {
                        const sat = intersects[0].object;
                        const targetUrl = sat.userData.url;

                        console.log('üì± Mobile tap on satellite:', sat.userData.name, '->', targetUrl);

                        // Navigate directly to the correct page (no auth checks for main systems)
                        if (targetUrl && targetUrl !== '#') {
                            window.location.href = targetUrl;
                        }
                    }
                }
                isDragging = false;
            });
            container.addEventListener('click', function(event) {
                const rect = container.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(satellites);

                if (intersects.length > 0) {
                    const sat = intersects[0].object;
                    const targetUrl = sat.userData.url;

                    console.log('üñ±Ô∏è Desktop click on satellite:', sat.userData.name, '->', targetUrl);

                    // Navigate directly to the correct page (no auth checks for main systems)
                    if (targetUrl && targetUrl !== '#') {
                        window.location.href = targetUrl;
                    }
                }
            });
            const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                console.log('üì± Mobile device detected - adjusting for touch interaction');

                // Make satellites larger for touch
                satellites.forEach(satellite => {
                    satellite.scale.setScalar(2.0); // 100% larger for touch
                });

                // Adjust camera for mobile view
                camera.position.z = 20; // Pull back slightly for mobile

                // Make labels larger on mobile
                labels.forEach(label => {
                    label.scale.set(5, 1.2, 1); // Larger text on mobile
                });
            }

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);

                // Rotate earth
                earth.rotation.y += 0.005;

                // Rotate satellites and update labels (maintain even spacing)
                const time = Date.now() * 0.0001; // Same speed for all satellites
                satellites.forEach((satellite, index) => {
                    const radius = 11;
                    // Each satellite maintains its initial angular position + global rotation
                    const baseAngle = (index / satellites.length) * Math.PI * 2;
                    const angle = baseAngle + time;

                    satellite.position.x = Math.cos(angle) * radius;
                    satellite.position.z = Math.sin(angle) * radius;
                    satellite.position.y = 0; // Keep consistent height

                    satellite.rotation.y += 0.01;

                    // Update corresponding label position
                    if (labels[index]) {
                        const label = labels[index];
                        label.position.x = Math.cos(angle) * (radius + 1.5);
                        label.position.z = Math.sin(angle) * (radius + 1.5);
                        label.position.y = 1.2; // Fixed height above satellites

                        // Make labels face the camera
                        label.lookAt(camera.position);
                    }
                });

                controls.update();
                renderer.render(scene, camera);
            }

            animate();

            // Mark as initialized
            window.globeInitialized = true;

            console.log('‚úÖ Globe initialized, making visible...');

            // Make container visible
            container.style.display = 'block';
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100vw';
            container.style.height = '100vh';
            container.style.zIndex = '1';

            console.log('üéâ 3D Globe fully initialized and visible!');

            // Hide welcome overlay
            setTimeout(function() {
                const overlay = document.querySelector('.welcome-overlay');
                console.log('üëã Looking for welcome overlay:', overlay);
                if (overlay) {
                    console.log('‚úÖ Found overlay, hiding...');
                    overlay.style.display = 'none';
                    console.log('‚úÖ Welcome overlay hidden!');
                } else {
                    console.log('‚ùå Welcome overlay not found!');
                }
            }, 500);

        } catch (error) {
            console.error('‚ùå Globe initialization failed:', error);
            container.innerHTML = '<div style="color: red; text-align: center; padding: 50px; font-family: monospace; background: rgba(0,0,0,0.9); color: white;">‚ùå 3D Scene Failed to Load<br>Error: ' + error.message + '<br><button onclick="location.reload()" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">üîÑ Refresh Page</button></div>';
        }
    }

    </script>

    <script src="public/facetProcessor.js"></script>
    <script src="public/simulation.js"></script>
    <script src="public/phantomLogin.js"></script>
    <!-- Register Service Worker - DISABLED -->
    <script>
    // Service Worker disabled to prevent cache issues
    /*
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("service-worker.js").then(function (registration) {
          console.log("Service Worker registered with scope:", registration.scope);
        }, function (err) {
          console.log("Service Worker registration failed:", err);
        });
      });
    }
    */
  </script>
        <script>
console.log('[DEBUG] index.html loaded');
console.log('[DEBUG] currentUser:', localStorage.getItem('currentUser'));
console.log('[DEBUG] userProfile:', localStorage.getItem('userProfile'));
console.log('[DEBUG] userLoggedIn:', localStorage.getItem('userLoggedIn'));
console.log('[DEBUG] lastWalletAuth:', localStorage.getItem('lastWalletAuth'));
</script>

    </body>
</html>
