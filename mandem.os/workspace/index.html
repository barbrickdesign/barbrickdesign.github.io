<!DOCTYPE html> 
<html lang="en"> 
    <head> 
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"> 
        <title>Gem Bot Universe for this project by Ryan Barbrick. of BarbrickDesign.com</title>         
        <link href="css/theme.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="public/styles.css"> 
        <!-- Link to the manifest -->         
        <link rel="manifest" href="../../manifest.json"> 
        <!-- Set theme color -->         
        <meta name="theme-color" content="#0ff"> 
        <!-- Apple Touch Icon -->         
        <link rel="apple-touch-icon" href="public/apple-touch-icon.png"> 
        <!-- Import Orbitron font -->         
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"> 
        <style>
/* Modal styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
.modal-content {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  padding: 30px;
  border-radius: 16px;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0, 255, 153, 0.3);
  border: 2px solid #00ff99;
  text-align: center;
}
.modal-content h3 {
  margin: 0 0 15px 0;
  color: #00ff99;
  font-size: 24px;
}
.modal-content p {
  margin: 0 0 20px 0;
  color: #ccc;
  line-height: 1.6;
}
.modal-content .auth-button {
  margin: 8px;
  min-width: 140px;
}
/* Move login button to bottom left on mobile */
@media (max-width: 700px) {
  #loginBtn {
    position: fixed !important;
    left: 18px;
    bottom: 18px;
    z-index: 1200;
    margin: 0 !important;
    width: auto;
    min-width: 90px;
    border-radius: 8px;
    box-shadow: 0 2px 8px #0002;
  }
  #profileBtn {
    position: fixed !important;
    left: 18px;
    bottom: 18px;
    z-index: 1200;
    margin: 0 !important;
    width: auto;
    min-width: 90px;
    border-radius: 8px;
    box-shadow: 0 2px 8px #0002;
  }
}
/* Mobile table scroll */
@media (max-width: 700px) {
  table, .stat-table {
    display: block;
    overflow-x: auto;
    width: 100%;
    max-width: 100vw;
  }
  th, td {
    min-width: 90px;
    font-size: 15px;
  }
  .profile-card, .container, .post-login-content {
    padding: 8px !important;
  }
}
/* Larger touch targets for mobile */
@media (max-width: 700px) {
  button, .auth-button {
    min-height: 44px;
    font-size: 18px;
  }
}

/* Ensure 3D globe is always visible */
#globe-container {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 1 !important;
  display: block !important;
}
</style>
    
    <!-- Universal Wallet Authentication System -->
    <script src="../../src/core/contractor-registry.js"></script>
    <script src="../../src/core/universal-wallet-auth.js"></script>
    <script src="../../src/core/auth-integration.js"></script>

    <!-- Shared Systems -->
    <script src="../../src/utils/shared-utilities.js"></script>
    <script src="../../src/utils/shared-wallet-system.js"></script>
    </head>     
    <body> 
        <header>
            <div class="header-left">
                <button id="contentToggleBtn" class="content-toggle-button">Mission Control</button>
            </div>
            <h1>Gem Bot Universe</h1>
            <p class="header-desc">by Ryan Barbrick ¬∑ BarbrickDesign.com<br>Explore our virtual environments and trading systems.</p>
            <div class="auth-links-header" id="authLinksHeader" style="margin-top:1em; text-align:center;">
                <a href="login.html" class="auth-button" id="loginBtn" style="display: inline-block;">Log In</a>
                <a href="profile.html" class="auth-button" id="profileBtn" style="display:none;">Profile</a>
            </div>
        </header>         
        <!-- Fullscreen 3D globe container -->         
        <div id="globe-container"> 
            <!-- 3D Globe will be rendered here by Three.js -->             
        </div>         
        <div class="tooltip" id="globeTooltip"></div>         
        <!-- Welcome overlay -->
        <div class="welcome-overlay">
            <h2>Gem Bot Universe</h2>
            <p>Explore our interactive 3D environments and trading systems by navigating the Globe Interface. Access the Laboratory for research, Warehouse for storage, Explorer for real-world navigation, and Grand Exchange for trading.</p>

            <!-- Feature overview -->
            <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üè≠</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Laboratory</div>
                    <div style="font-size: 12px; opacity: 0.8;">Research & development</div>
                </div>
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üèóÔ∏è</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Warehouse</div>
                    <div style="font-size: 12px; opacity: 0.8;">Storage & inventory</div>
                </div>
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üó∫Ô∏è</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Explorer</div>
                    <div style="font-size: 12px; opacity: 0.8;">Real-world navigation</div>
                </div>
                <div style="text-align: center; min-width: 140px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">‚öîÔ∏è</div>
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Grand Exchange</div>
                    <div style="font-size: 12px; opacity: 0.8;">Trading & marketplace</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="hideWelcomeOverlay()" style="
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                ">‚ú® Enter Gem Bot Universe</button>
            </div>
        </div>         
        <!-- Post-login content (initially hidden) -->         
        <div class="post-login-content" id="postLoginContent" style="display:none;">
            <section id="labControls">
                <h2>Gem Bot Universe Control Center</h2>
                <p>Access and manage your Gem Bot systems:</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <button id="launchLabBtn" style="background: linear-gradient(135deg, #00ff99, #00cc66); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        üè≠ Launch Laboratory<br><small>Research & Development</small>
                    </button>

                    <button id="launchWarehouseBtn" style="background: linear-gradient(135deg, #ffaa00, #ff8800); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        üèóÔ∏è Access Warehouse<br><small>Storage & Inventory</small>
                    </button>

                    <button id="launchExplorerBtn" style="background: linear-gradient(135deg, #66ff99, #00ff88); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        üó∫Ô∏è Start Explorer<br><small>Real-world Navigation</small>
                    </button>

                    <button id="launchExchangeBtn" style="background: linear-gradient(135deg, #ffd700, #ffb300); padding: 20px; border-radius: 10px; border: none; color: white; font-size: 16px; cursor: pointer;">
                        ‚öîÔ∏è Enter Grand Exchange<br><small>Trading & Marketplace</small>
                    </button>
                </div>

                <button id="checkConnectionBtn" style="background: #2196f3; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 10px;">
                    üîó Check System Status
                </button>

                <button id="syncSettingsBtn" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 10px;">
                    üîÑ Sync Settings
                </button>
            </section>
        </div>         </div>

        <!-- Agent/Tester Log Panel -->
        <div class="profile-card" id="agentLogPanel" style="display:none;">
            <h2>System Activity Monitor</h2>
            <p>Real-time monitoring of Gem Bot Universe systems and components.</p>
            <button id="toggleAgentLog" class="auth-button" style="margin-top: 10px;">Hide Monitor</button>
        </div>

        <!-- Move All Players button to bottom right, left of chat -->
        <button id="showAgentLogBtn" class="auth-button all-players-bottom-btn" style="display:none;">System Monitor</button>
        <!-- Login Check Modal (Now non-blocking) -->         
        <div id="loginModal" class="modal" style="display:none"> 
            <div class="modal-content"> 
                <h3>Enhanced Features Available</h3> 
                <p>Connect your wallet to access advanced features like live feeds, MGC balance tracking, and exclusive 3D environments.</p> 
                <button id="modalLoginBtn" class="auth-button">Connect Wallet</button>                 
                <button id="modalCloseBtn" class="auth-button">Continue Without Login</button>                 
            </div>             
        </div>         
        <footer> 
            <p>&copy; 2025 Gem Bot Project | All Rights Reserved</p> 
        </footer>         
        <!-- Load JavaScript files -->         
        <!-- Solana Wallet Integration -->
        <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.8/lib/index.iife.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
        <script src="public/phantomLogin.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>         
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>         
        <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>         
        <!-- New globe script -->         
        <script>
    // Check if the user is logged in
    function isUserLoggedIn() {
      // Check for both authentication methods to ensure compatibility
      return localStorage.getItem('currentUser') !== null || localStorage.getItem('userLoggedIn') === 'true';
    }

    // Wallet-based authentication check (same as profile.js)
    function isUserAuthenticated() {
      const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
      const lastAuth = localStorage.getItem('lastWalletAuth');
      if (!user || !user.walletAddress || !lastAuth) return false;
      const lastAuthTime = new Date(lastAuth).getTime();
      const now = Date.now();
      return (now - lastAuthTime) < 86400000;
    }

    function updateAuthButton() {
      const loginBtn = document.getElementById('loginBtn');
      const profileBtn = document.getElementById('profileBtn');
      if (isUserAuthenticated()) {
        loginBtn.style.display = 'none';
        profileBtn.style.display = 'inline-block';
        profileBtn.textContent = 'Profile';
        profileBtn.href = 'profile.html';
      } else {
        loginBtn.style.display = 'inline-block';
        loginBtn.textContent = 'Log In';
        profileBtn.style.display = 'none';
      }
    }

    // Show login modal (optional, non-blocking)
    function showLoginModal() {
      const modal = document.getElementById('loginModal');
      if (modal) {
        modal.style.display = 'flex';
      }
    }
    
    // Update UI based on login state (non-blocking)
    function updateUIForLoginState() {
      const isLoggedIn = isUserLoggedIn();
      const contentToggleBtn = document.getElementById('contentToggleBtn');
      const welcomeOverlay = document.querySelector('.welcome-overlay');
      
      // Always show content toggle for better UX
      if (contentToggleBtn) {
        contentToggleBtn.style.display = 'block';
      }
      
      // Hide welcome overlay after first visit or if logged in
      if (isLoggedIn || localStorage.getItem('visited')) {
        if (welcomeOverlay) welcomeOverlay.style.display = 'none';
      }
      
      // Mark as visited
      localStorage.setItem('visited', 'true');
    }
    
    // Enhanced wallet connection using shared wallet system
    async function connectWalletForMGC() {
      try {
        if (window.sharedWalletSystem) {
          await window.sharedWalletSystem.connect();
          console.log('‚úÖ Wallet connected via shared system');
          updateAuthButton();
          updateMgcBalanceDisplay();
          return true;
        }

        // Fallback to old system if shared system not available
        return await quickConnectWallet();
      } catch (error) {
        console.error('‚ùå Wallet connection failed:', error);
        alert('Wallet connection failed. Please try again.');
        return false;
      }
    }
    
    // Fallback wallet connection for backward compatibility
    async function quickConnectWallet() {
      try {
        const provider = window.solana;
        if (!provider || !provider.isPhantom) {
          alert('Phantom wallet not found. Please install Phantom browser extension.');
          window.open('https://phantom.app/', '_blank');
          return false;
        }
        
        const resp = await provider.connect();
        const publicKey = resp.publicKey.toBase58();
        
        // Store basic auth info
        const user = {
          walletAddress: publicKey,
          displayName: `User ${publicKey.slice(0, 4)}...${publicKey.slice(-4)}`,
          joinDate: new Date().toISOString()
        };
        
        localStorage.setItem('currentUser', JSON.stringify(user));
        localStorage.setItem('userLoggedIn', 'true');
        localStorage.setItem('lastWalletAuth', new Date().toISOString());
        
        // Update UI
        updateAuthButton();
        updateMgcBalanceDisplay();
        
        console.log('[Auth] Wallet connected:', publicKey);
        return true;
      } catch (err) {
        console.error('[Auth] Connection failed:', err);
        alert('Wallet connection failed. Please try again.');
        return false;
      }
    }
    
    // Soft auth check (suggest login but don't block)
    function enforceAuthNavigation() {
      const protectedPages = [
        'profile.html', 'admin-forge.html'
      ];
      const openPage = window.location.pathname.split('/').pop();
      if (protectedPages.includes(openPage) && !isUserAuthenticated()) {
        localStorage.setItem('authRedirect', openPage);
        window.location.href = 'login.html';
      }
      // Other pages are accessible without login but show login prompt
    }

    // Show MGC balance if user is logged in
    function showMgcBalance(balance) {
      const mgcDiv = document.getElementById('mgcBalanceDisplay');
      const mgcSpan = document.getElementById('mgcBalance');
      if (mgcDiv && mgcSpan) {
        mgcDiv.style.display = 'block';
        mgcSpan.textContent = balance;
      }
    }
    
    // Simulate fetching MGC balance for the logged-in user
    function fetchMgcBalance() {
      // TODO: Replace with real API call to fetch MGC balance from Solana/Phantom wallet
      // For now, simulate with a random value
      return new Promise(resolve => {
        setTimeout(() => {
          const fakeBalance = (Math.random() * 1000).toFixed(2);
          resolve(fakeBalance);
        }, 600);
      });
    }
    
    function updateMgcBalanceDisplay() {
      const mgcDiv = document.getElementById('mgcBalanceDisplay');
      const mgcSpan = document.getElementById('mgcBalance');
      const displayMgcSpan = document.getElementById('displayMgcBalance');
      
      if (!isUserAuthenticated()) {
        if (mgcDiv) mgcDiv.style.display = 'none';
        if (displayMgcSpan) displayMgcSpan.textContent = '0.00';
        return;
      }
      
      if (mgcDiv) mgcDiv.style.display = 'block';
      // Get balance from localStorage (real-time in-game MGC)
      let profile = JSON.parse(localStorage.getItem('userProfile') || 'null');
      let balance = profile && profile.inGameMGC ? profile.inGameMGC : 0;
      
      if (mgcSpan) mgcSpan.textContent = balance.toFixed ? balance.toFixed(2) : balance;
      if (displayMgcSpan) displayMgcSpan.textContent = balance.toFixed ? balance.toFixed(2) : balance;
    }

    // Toggle the post-login content
    function toggleControls() {
      const postLoginContent = document.getElementById('postLoginContent');
      const toggleBtn = document.getElementById('contentToggleBtn');
      if (postLoginContent.style.display === 'block') {
        postLoginContent.style.display = 'none';
        toggleBtn.textContent = 'Mission Control';
        console.log('Mission Control hidden');
      } else {
        postLoginContent.style.display = 'block';
        toggleBtn.textContent = 'Hide Mission Control';
        console.log('Mission Control shown');
      }
    }
    
    // Add click handler for MGC balance link to go to profile
    const mgcLink = document.getElementById('mgcBalanceLink');
    if (mgcLink) {
      mgcLink.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'profile.html';
      });
    }

    // Update UI based on login state
    updateUIForLoginState();

    // Show MGC balance if logged in
    if (isUserLoggedIn()) {
      fetchMgcBalance().then(showMgcBalance);
    }

    // Update auth buttons
    updateAuthButton(); // Ensure button is correct on page load
    enforceAuthNavigation();

    // Update profileBtn click to go to login if not authenticated
    document.getElementById('profileBtn').addEventListener('click', function(e) {
      if (!isUserAuthenticated()) {
        e.preventDefault();
        window.location.href = 'login.html';
      }
    });

    // Initialize 3D Globe immediately when page loads
    // This ensures the 3D scene renders before welcome overlay logic
    window.addEventListener('load', function() {
        console.log('üöÄ Initializing Gem Bot Universe 3D Scene...');

        // Hide welcome overlay immediately
        const welcomeOverlay = document.querySelector('.welcome-overlay');
        if (welcomeOverlay) {
            welcomeOverlay.style.display = 'none';
            console.log('‚úÖ Welcome overlay hidden immediately');
        }

        initGlobe();
    });

    // Also initialize on DOMContentLoaded as backup
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM ready, ensuring 3D scene...');
        if (!window.globeInitialized) {
            initGlobe();
        }

        // Setup welcome overlay hover disappear
        const welcomeOverlay = document.querySelector('.welcome-overlay');
        let hoverTimer;

        if (welcomeOverlay) {
            welcomeOverlay.addEventListener('mouseenter', function() {
                hoverTimer = setTimeout(function() {
                    welcomeOverlay.style.opacity = '0';
                    setTimeout(function() {
                        welcomeOverlay.style.display = 'none';
                    }, 1000);
                }, 2000);
            });

            welcomeOverlay.addEventListener('mouseleave', function() {
                clearTimeout(hoverTimer);
            });
        }

        // Setup modal buttons
        const modalLoginBtn = document.getElementById('modalLoginBtn');
        if (modalLoginBtn) {
            modalLoginBtn.addEventListener('click', function() {
                window.location.href = 'login.html';
            });
        }

        const modalCloseBtn = document.getElementById('modalCloseBtn');
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', function() {
                document.getElementById('loginModal').style.display = 'none';
            });
        }

        // Setup content toggle button
        const contentToggleBtn = document.getElementById('contentToggleBtn');
        if (contentToggleBtn) {
            contentToggleBtn.addEventListener('click', toggleControls);
        }

        // Add click handler for MGC balance link to go to profile
        const mgcLink = document.getElementById('mgcBalanceLink');
        if (mgcLink) {
            mgcLink.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'profile.html';
            });
        }

        // Update UI based on login state
        updateUIForLoginState();

        // Show MGC balance if logged in
        if (isUserLoggedIn()) {
            fetchMgcBalance().then(showMgcBalance);
        }

        // Update auth buttons
        updateAuthButton();
        enforceAuthNavigation();

        // Update profileBtn click to go to login if not authenticated
        const profileBtn = document.getElementById('profileBtn');
        if (profileBtn) {
            profileBtn.addEventListener('click', function(e) {
                if (!isUserAuthenticated()) {
                    e.preventDefault();
                    window.location.href = 'login.html';
                }
            });
        }

        setInterval(updateMgcBalanceDisplay, 1000);
        updateMgcBalanceDisplay();
    }); 

    function initGlobe() {
      try {
        // Prevent duplicate initialization
        if (window.globeInitialized) {
          console.log('‚úÖ Globe already initialized');
          return;
        }

        console.log('üåç Starting 3D globe initialization...');

        // Get the container
        const container = document.getElementById('globe-container');

        if (!container) {
          console.error('‚ùå Globe container not found!');
          return;
        }

        // Check if Three.js is loaded
        if (typeof THREE === 'undefined') {
          console.error('‚ùå Three.js not loaded! Retrying in 1 second...');
          setTimeout(initGlobe, 1000);
          return;
        }

        console.log('‚úÖ Three.js loaded, creating scene...');

        // Setup Three.js scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });

        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        console.log('‚úÖ 3D Scene created successfully!');

        // Mark as initialized
        window.globeInitialized = true;

        // Ensure globe container is visible
        container.style.display = 'block';
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.width = '100vw';
        container.style.height = '100vh';
        container.style.zIndex = '1';

        console.log('‚úÖ Globe container made visible');

        // Add ambient light
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        // Add directional light
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 3, 5);
        scene.add(directionalLight);

        // Create Earth globe with real texture
        const earthGeometry = new THREE.SphereGeometry(5, 64, 64);
        const earthMaterial = new THREE.MeshPhongMaterial({
          map: null,
          bumpMap: null,
          bumpScale: 0.05,
          specularMap: null,
          specular: new THREE.Color(0x111111),
          shininess: 25,
          transparent: true,
          opacity: 0.95
        });

        // Load real Earth texture
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load(
          'https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/earthmap1k.jpg',
          function(texture) {
            earthMaterial.map = texture;
            earthMaterial.needsUpdate = true;
            console.log('‚úÖ Earth texture loaded successfully');
          },
          function(progress) {
            console.log('Earth texture loading progress:', progress);
          },
          function(error) {
            console.warn('Earth texture failed to load, using fallback:', error);
            // Create fallback procedural texture
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 1024;
            canvas.height = 512;
            const imageData = context.createImageData(canvas.width, canvas.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
              const x = (i / 4) % canvas.width;
              const y = Math.floor((i / 4) / canvas.width);
              const noise1 = Math.sin(x * 0.01) * Math.cos(y * 0.01);
              const noise2 = Math.sin(x * 0.02 + y * 0.03) * 0.5;
              const noise3 = Math.sin(x * 0.005) * Math.sin(y * 0.008) * 0.3;
              const continentValue = noise1 + noise2 + noise3;
              if (continentValue > 0.1) {
                imageData.data[i] = Math.floor(34 + Math.random() * 50);
                imageData.data[i + 1] = Math.floor(139 + Math.random() * 50);
                imageData.data[i + 2] = Math.floor(34 + Math.random() * 20);
              } else {
                imageData.data[i] = Math.floor(25 + Math.abs(continentValue) * 30);
                imageData.data[i + 1] = Math.floor(25 + Math.abs(continentValue) * 50);
                imageData.data[i + 2] = Math.floor(112 + Math.abs(continentValue) * 50);
              }
              imageData.data[i + 3] = 255;
            }
            context.putImageData(imageData, 0, 0);
            const earthTexture = new THREE.CanvasTexture(canvas);
            earthTexture.wrapS = THREE.RepeatWrapping;
            earthTexture.wrapT = THREE.RepeatWrapping;
            earthMaterial.map = earthTexture;
            earthMaterial.needsUpdate = true;
          }
        );

        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        scene.add(earth);

        // Position camera
        camera.position.z = 18;
        camera.position.y = 2;

        // Add orbit controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 7;
        controls.maxDistance = 20;

        // Create satellites
        const satellites = [];
        const environments = [
          { name: 'Grand Exchange', color: 0x3399ff, url: '../grand-exchange.html',
            description: 'Access the high-tech trading center for resources and bots.' },
          { name: 'Laboratory', color: 0x00cc66, url: '../laboratory.html',
            description: 'Research and develop new Gem Bot technologies.' },
          { name: 'Warehouse', color: 0xffcc00, url: '../warehouse.html',
            description: 'Storage facility for components and finished Gem Bots.' },
          { name: 'Explorer', color: 0x66ff99, url: '../outdoor.html',
            description: 'Real-time geo-location exploration with MGC mining portals.' },
        ];

        environments.forEach((env, index) => {
          const angle = (index / environments.length) * Math.PI * 2;
          const radius = 11;

          let satelliteMaterial;
          if (env.name === 'Laboratory') {
            satelliteMaterial = new THREE.MeshPhongMaterial({
              color: 0x3a0066,
              emissive: 0x1a0033,
              emissiveIntensity: 0.8,
              shininess: 120,
              specular: 0x00ff99
            });
          } else if (env.name === 'Grand Exchange') {
            satelliteMaterial = new THREE.MeshPhongMaterial({
              color: 0xffd700,
              emissive: 0xc0c0c0,
              emissiveIntensity: 0.8,
              shininess: 120,
              specular: 0xffffff
            });
          } else {
            satelliteMaterial = new THREE.MeshPhongMaterial({
              color: env.color,
              emissive: new THREE.Color(env.color).multiplyScalar(0.3),
              emissiveIntensity: 0.6,
              shininess: 100
            });
          }

          const satelliteGeometry = new THREE.SphereGeometry(1, 16, 16);
          const satellite = new THREE.Mesh(satelliteGeometry, satelliteMaterial);

          satellite.position.x = Math.cos(angle) * radius;
          satellite.position.y = Math.sin(angle) * 1.5;
          satellite.position.z = Math.sin(angle) * radius;
          satellite.scale.setScalar(1.5);

          satellite.userData = {
            name: env.name,
            url: env.url,
            description: env.description,
            originalColor: env.color,
            hoverColor: new THREE.Color(env.color).offsetHSL(0, 0, 0.2),
            pulsePhase: Math.random() * Math.PI * 2,
            baseEmissiveIntensity: satelliteMaterial.emissiveIntensity || 0.6
          };

          scene.add(satellite);
          satellites.push(satellite);
        });

        // Setup tooltip
        const tooltip = document.getElementById('globeTooltip');

        // Raycaster for interactions
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // Mouse move event for hover effect
        container.addEventListener('mousemove', function(event) {
          const rect = renderer.domElement.getBoundingClientRect();
          mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

          raycaster.setFromCamera(mouse, camera);
          const intersects = raycaster.intersectObjects(satellites);

          satellites.forEach(sat => {
            if (sat.material && sat.material.emissive) {
              sat.material.emissive.setHex(sat.userData.originalColor);
            }
          });

          tooltip.style.opacity = '0';

          if (intersects.length > 0) {
            const sat = intersects[0].object;
            sat.material.emissive = sat.userData.hoverColor;
            document.body.style.cursor = 'pointer';

            tooltip.innerHTML = `<strong>${sat.userData.name}</strong><br>${sat.userData.description}`;
            tooltip.style.opacity = '1';
            tooltip.style.left = event.clientX + 'px';
            tooltip.style.top = (event.clientY - 40) + 'px';
          } else {
            document.body.style.cursor = 'auto';
          }
        });

        // Click event for navigation
        container.addEventListener('click', function(event) {
          const rect = renderer.domElement.getBoundingClientRect();
          mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
          raycaster.setFromCamera(mouse, camera);
          const intersects = raycaster.intersectObjects(satellites);

          if (intersects.length > 0) {
            const sat = intersects[0].object;
            const targetUrl = sat.userData.url;
            const publicPages = ['laboratory.html', 'warehouse.html', 'outdoor.html', 'grand_exchange.html'];

            if (publicPages.some(page => targetUrl.includes(page)) || isUserLoggedIn()) {
              window.location.href = targetUrl;
            } else {
              // Show login modal
              const modal = document.getElementById('loginModal');
              if (modal) modal.style.display = 'flex';
            }
          }
        });

        // Handle window resize
        function onWindowResize() {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize);

        // Animation loop
        function animate() {
          requestAnimationFrame(animate);

          // Rotate earth
          earth.rotation.y += 0.001;

          // Animate satellites
          satellites.forEach((satellite, index) => {
            const speed = 0.0001 * (1 + index * 0.1);
            const angle = (Date.now() * speed) % (Math.PI * 2);
            const radius = 11;

            satellite.position.x = Math.cos(angle + index) * radius;
            satellite.position.z = Math.sin(angle + index) * radius;

            const pulseIntensity = satellite.userData.baseEmissiveIntensity +
                                Math.sin(Date.now() * 0.003 + satellite.userData.pulsePhase) * 0.3;
            if (satellite.material.emissiveIntensity !== undefined) {
              satellite.material.emissiveIntensity = Math.max(0.2, pulseIntensity);
            }

            satellite.rotation.y += 0.01;
          });

          controls.update();
          renderer.render(scene, camera);
        }

        animate();

        console.log('üéâ Gem Bot Universe 3D Scene fully loaded and running!');

      } catch (error) {
        console.error('‚ùå Failed to initialize 3D globe:', error);

        // Fallback: Show error message
        const container = document.getElementById('globe-container');
        if (container) {
          container.innerHTML = `
            <div style="color: red; text-align: center; padding: 50px; font-family: monospace;">
              <h2>‚ùå 3D Scene Failed to Load</h2>
              <p>Error: ${error.message}</p>
              <p>Please refresh the page or check your browser compatibility.</p>
              <button onclick="location.reload()" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üîÑ Refresh Page
              </button>
            </div>
          `;
        }
      }
    }
    <script src="public/facetProcessor.js"></script>
    <script src="public/simulation.js"></script>
    <script src="public/phantomLogin.js"></script>
    <!-- Register Service Worker - DISABLED -->
    <script>
    // Service Worker disabled to prevent cache issues
    /*
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("service-worker.js").then(function (registration) {
          console.log("Service Worker registered with scope:", registration.scope);
        }, function (err) {
          console.log("Service Worker registration failed:", err);
        });
      });
    }
    */
  </script>
        <script>
console.log('[DEBUG] index.html loaded');
console.log('[DEBUG] currentUser:', localStorage.getItem('currentUser'));
console.log('[DEBUG] userProfile:', localStorage.getItem('userProfile'));
console.log('[DEBUG] userLoggedIn:', localStorage.getItem('userLoggedIn'));
console.log('[DEBUG] lastWalletAuth:', localStorage.getItem('lastWalletAuth'));
</script>

<!-- Mandem.OS Universal Auth Integration -->
<script>
// Initialize wallet authentication for Mandem.OS
window.addEventListener('DOMContentLoaded', async () => {
    console.log('üåê Mandem.OS - Initializing Universal Auth...');

    try {
        // Initialize universal auth with custom integration
        await window.authIntegration.init({
            showUI: false,  // Use existing login UI
            onAuthSuccess: (authInfo) => {
                console.log('‚úÖ Mandem.OS - Wallet authenticated:', authInfo.address);
                updateMandemAuthUI(authInfo);
            },
            onAuthFail: () => {
                console.log('‚ö†Ô∏è Mandem.OS - Wallet not connected');
            }
        });
    } catch (error) {
        console.error('‚ùå Mandem.OS - Auth init failed:', error);
    }
});

// Update Mandem.OS auth UI
function updateMandemAuthUI(authInfo) {
    const loginBtn = document.getElementById('loginBtn');
    const profileBtn = document.getElementById('profileBtn');

    if (authInfo && authInfo.authenticated) {
        // User is authenticated
        if (loginBtn) loginBtn.style.display = 'none';
        if (profileBtn) {
            profileBtn.style.display = 'inline-block';
            profileBtn.textContent = `üë§ ${authInfo.shortAddress}`;
        }

        // Show work time if available
        if (authInfo.workTimeMinutes > 0) {
            const hours = Math.floor(authInfo.workTimeMinutes / 60);
            const mins = authInfo.workTimeMinutes % 60;
            console.log(`‚è±Ô∏è Work time: ${hours}h ${mins}m`);
        }
    } else {
        // User is not authenticated
        if (loginBtn) loginBtn.style.display = 'inline-block';
        if (profileBtn) profileBtn.style.display = 'none';
    }
}

// Enhance login button to use universal auth
const originalLoginBtn = document.getElementById('loginBtn');
if (originalLoginBtn) {
    originalLoginBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        try {
            const authInfo = await window.universalWalletAuth.connect();
            if (authInfo) {
                console.log('‚úÖ Mandem.OS wallet connected:', authInfo);
                updateMandemAuthUI(authInfo);
            }
        } catch (error) {
            console.error('‚ùå Mandem.OS wallet connection error:', error);
            alert('Wallet connection failed: ' + error.message);
        }
    });
}

// Listen for auth events
window.addEventListener('authSuccess', (event) => {
    console.log('üéâ Mandem.OS - Auth success event:', event.detail);
    updateMandemAuthUI(event.detail);
});

window.addEventListener('authLogout', () => {
    console.log('üëã Mandem.OS - Auth logout event');
    updateMandemAuthUI(null);
    // Reset GBPT balance on logout
    const gbptSpan = document.getElementById('mndmBalance');
    if (gbptSpan) gbptSpan.textContent = '0';
});

// Update GBPT Token Balance (GBPT) in header
async function updateGBPTBalance() {
    try {
        const gbptSpan = document.getElementById('mndmBalance');
        if (!gbptSpan) return;

        // Get connected wallet address
        const walletAddress = window.universalWalletAuth && window.universalWalletAuth.getAddress();

        if (!walletAddress) {
            // No wallet connected - show 0
            gbptSpan.textContent = '0';
            return;
        }

        // Fetch GBPT token balance
        const balance = await window.getTokenBalance(walletAddress);

        // Update display
        const formattedBalance = window.formatTokenAmount(balance, 2);
        gbptSpan.textContent = formattedBalance;

        console.log('üî• Mandem.OS - GBPT Balance Updated:', formattedBalance);
    } catch (error) {
        console.error('‚ùå Mandem.OS - Failed to update GBPT balance:', error);
        const gbptSpan = document.getElementById('mndmBalance');
        if (gbptSpan) gbptSpan.textContent = '0';
    }
}

// Update GBPT balance when wallet connects
window.addEventListener('authSuccess', (event) => {
    console.log('üéâ Mandem.OS - Auth success, updating GBPT balance...');
    updateGBPTBalance();
});

// Initial GBPT balance update on page load
setTimeout(() => {
    updateGBPTBalance();
}, 1500); // Wait 1.5 seconds for auth to initialize

console.log('‚úÖ Mandem.OS - Wallet integration loaded');
console.log('üî• GBPT Token tracking enabled');
console.log('üíé MGC Promotion System loaded');
</script>

    </body>
</html>
