<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BarbrickDesign — Build, Recover, and Earn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Mythic automation, recovery portals, MMO, coin forges, and on-site LLM access for coin holders. Build, recover, and earn." />
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root {
      --bg: #0a0c11;
      --panel: #0f131a;
      --glass: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.14);
      --text: #eaf1fb;
      --muted: #a8b3c7;
      --accent: #66fcf1;
      --accent2: #9b7bff;
      --good: #3be477;
      --warn: #fbbf24;
      --bad: #ff6b6b;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background: radial-gradient(1200px 600px at 20% -20%, rgba(102,252,241,0.08), transparent), var(--bg); color: var(--text); }
    a { color: var(--accent); text-decoration: none; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }

    /* Header */
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .glyph { width: 42px; height: 42px; border-radius: 10px; background: conic-gradient(from 210deg, var(--accent), var(--accent2), var(--accent)); box-shadow: 0 0 80px rgba(102,252,241,0.25); animation: spin 12s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg)} 100% { transform: rotate(360deg)} }
    .nav { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { background: #121827; color: var(--text); border: 1px solid #223149; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.2s ease; }
    .btn:hover { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(102,252,241,0.12); }
    .btn.primary { background: linear-gradient(135deg, #121a2b, #172238); border-color: #2a3f62; }
    .btn.ghost { background: transparent; border-color: var(--stroke); }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--stroke); background: var(--glass); font-size: 12px; color: var(--muted); }

    /* Hero */
    .hero { margin-top: 18px; padding: 24px; border-radius: 20px; background: linear-gradient(180deg, rgba(102,252,241,0.08), rgba(102,252,241,0) 30%), var(--panel); border: 1px solid var(--stroke); display: grid; gap: 12px; }
    .title { font-size: 34px; font-weight: 900; letter-spacing: 0.6px; }
    .subtitle { color: var(--muted); font-size: 16px; }
    .hero-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 950px) { .hero-grid { grid-template-columns: 1.3fr 0.7fr; } }
    .card { background: var(--panel); border: 1px solid var(--stroke); border-radius: 16px; padding: 16px; }
    .big { font-size: 40px; font-weight: 900; letter-spacing: 0.3px; }
    .small { font-size: 12px; color: var(--muted); }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .hr { height: 1px; background: var(--stroke); border: 0; margin: 12px 0; }
    .select { appearance: none; background: #121827; border: 1px solid #223149; color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; }

    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
    .stat { text-align: center; background: var(--panel); border: 1px solid var(--stroke); border-radius: 16px; padding: 16px; }
    .stat .label { font-size: 12px; color: var(--muted); }
    .stat .val { font-size: 24px; font-weight: 800; }

    /* Modules */
    .modules { margin-top: 18px; display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1000px) { .modules { grid-template-columns: 1fr 1fr; } }
    .module-title { font-weight: 800; font-size: 16px; margin-bottom: 6px; }
    .grid { display: grid; gap: 10px; }
    .list { display: grid; gap: 8px; }
    .item { display: grid; grid-template-columns: 1.1fr 0.7fr 1fr; gap: 10px; align-items: center; }
    .link { color: var(--accent); font-weight: 700; }
    .note { font-size: 12px; color: var(--muted); }

    /* Feed */
    .feed { background: var(--panel); border: 1px solid var(--stroke); border-radius: 16px; padding: 12px; }
    .feed-head, .feed-row { display: grid; grid-template-columns: 1.2fr 0.7fr 0.9fr 1.4fr 1fr; gap: 8px; align-items: center; }
    .feed-head { font-weight: 700; color: var(--muted); font-size: 12px; }

    footer { margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--stroke); color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="glyph"></div>
        <div>
          <div class="mono" style="font-weight:800;">BarbrickDesign</div>
          <div class="small">Mythic automation, sovereign agents, and instant SOL recovery</div>
        </div>
      </div>
      <div class="nav">
        <button id="connectBtn" class="btn primary">Connect Wallet</button>
        <button id="resetBtn" class="btn">Reset</button>
        <a class="btn ghost" href="https://www.barbrickdesign.com" target="_blank" rel="noopener">Main site</a>
        <a class="btn ghost" href="https://github.com/barbrickdesign/barbrickdesign.github.io" target="_blank" rel="noopener">Repo</a>
        <a class="btn ghost" href="https://github.com/barbrickdesign?tab=repositories" target="_blank" rel="noopener">GitHub</a>
      </div>
    </header>

    <section class="hero">
      <div class="title">Build, recover, and earn — all in one place</div>
      <div class="subtitle">Close empty token accounts and reclaim SOL, mint mythic assets, access our coin-holder LLM, and link into every active project.</div>

      <div class="hero-grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div class="mono small">Wallet</div>
            <div id="walletLabel" class="mono small">—</div>
          </div>
          <div class="hr"></div>

          <div class="row" style="justify-content:center; gap:12px;">
            <label class="small">Recovery chain</label>
            <select id="chainSelect" class="select">
              <option value="solana" selected>Solana</option>
              <option value="ethereum">Ethereum</option>
              <option value="polygon">Polygon</option>
              <option value="bsc">BSC</option>
            </select>
          </div>

          <div class="big" id="refundEstimateBig">0.00000</div>
          <div class="small">Estimated recovery waiting for you</div>

          <div class="row" style="margin-top:10px;">
            <button id="recoverBtn" class="btn">Recover Now</button>
            <button id="scanBtn" class="btn ghost">Recalculate</button>
            <div class="badge">Only 5% fee — lowest in the game</div>
          </div>
          <div class="row" style="margin-top:8px;">
            <input id="refAddress" class="btn mono" style="min-width:280px; background:#0f141d;" placeholder="Optional referrer wallet (?ref=)" />
            <label class="badge"><input id="donationToggle" type="checkbox" checked /> <span class="small">Include 5% support</span></label>
          </div>
          <div id="status" class="small" style="min-height:18px; margin-top:8px;"></div>

          <div class="hr"></div>
          <div class="small">
            Multi-chain recovery aims to help users reclaim funds lost to test accounts, dust wallets, and fraud. We map activity via public explorers and client-side scans; deeper recovery scenarios may require a backend or specialized programs.
          </div>
        </div>

        <div class="card">
          <div class="module-title">Coin-holder LLM Access</div>
          <div class="small">Hold our coins or NFTs to unlock on-site LLM chat for strategy, dev help, and ritual design.</div>
          <div class="hr"></div>
          <div class="row">
            <div id="llmAccessBadge" class="badge">Access: locked</div>
            <button id="openLLM" class="btn" disabled>Open LLM</button>
          </div>
          <div class="note">Token-gated: we check balances for approved mints below. Connect your wallet to verify.</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><div class="label">Empty accounts (SOL)</div><div id="emptyCount" class="val">0</div></div>
        <div class="stat"><div class="label">Estimated refund (SOL)</div><div id="refundEstimate" class="val">0.00000 SOL</div></div>
        <div class="stat"><div class="label">Session actions</div><div id="sessionActions" class="val">0</div></div>
      </div>
    </section>

    <section class="modules">
      <div class="card">
        <div class="module-title">Income modules</div>
        <div class="grid">
          <div class="item">
            <div>
              <div class="link">SOL Recovery Portal</div>
              <div class="note">Close empty SPL token accounts in one click, reclaim rent, optional 5% support.</div>
            </div>
            <a class="btn ghost" href="https://barbrickdesign.github.io/SOLRecovery/" target="_blank" rel="noopener">Open</a>
            <button id="recoverInlineBtn" class="btn">Recover here</button>
          </div>
          <div class="item">
            <div>
              <div class="link">NFT Minting Portal</div>
              <div class="note">Mint lore-infused sigils and drop referrals. Configurable creator splits.</div>
            </div>
            <a class="btn ghost" href="#" onclick="alert('Mint portal coming soon'); return false;">Open</a>
            <button class="btn" id="mintSigil">Mint Sigil</button>
          </div>
          <div class="item">
            <div>
              <div class="link">Agent Consulting</div>
              <div class="note">Book time for sovereign automation architecture; paid in SOL or our coins.</div>
            </div>
            <a class="btn ghost" href="mailto:barbrickdesign@gmail.com?subject=Consulting%20Inquiry" target="_blank" rel="noopener">Email</a>
            <button class="btn" id="bookIntro">Book intro</button>
          </div>
          <div class="item">
            <div>
              <div class="link">Affiliate + Referrals</div>
              <div class="note">Earn SOL by sharing. Your ref gets 20% of support fees from recoveries you drive.</div>
            </div>
            <button class="btn" id="copyReferral">Copy my referral link</button>
            <span class="badge mono" id="refPreview">—</span>
          </div>
          <div class="item">
            <div>
              <div class="link">Shop + Support</div>
              <div class="note">Buy mythic merch or tip to fund RPC and drops.</div>
            </div>
            <a class="btn ghost" href="https://www.barbrickdesign.com" target="_blank" rel="noopener">Shop</a>
            <button class="btn" id="sendSupport">Send tip</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="module-title">Projects</div>
        <div class="list">
          <div><a class="link" href="https://barbrickdesign.github.io/city-3d/" target="_blank" rel="noopener">City‑3D</a> — interactive 3D city demo</div>
          <div><a class="link" href="https://barbrickdesign.github.io/SOLRecovery/" target="_blank" rel="noopener">SOL Recovery Portal</a> — reclaim rent fast</div>
          <div><a class="link" href="https://github.com/barbrickdesign?tab=repositories" target="_blank" rel="noopener">All GitHub projects</a> — forks, prototypes, and tooling</div>
          <div><a class="link" href="https://barbrickdesign.github.io/OpenAiExperiments/" target="_blank" rel="noopener">OpenAI Experiments</a> — playful explorations</div>
          <div><a class="link" href="https://barbrickdesign.github.io/OpenAI-Racecar-Simulation/" target="_blank" rel="noopener">Racecar Simulation</a> — kinetic sim</div>
          <div><a class="link" href="https://barbrickdesign.github.io/OpenAI-Helicopter-Take-Off/" target="_blank" rel="noopener">Helicopter Take-Off</a> — motion sim</div>
          <div class="note">More repositories and forks are showcased on the GitHub profile.</div>
        </div>
      </div>
    </section>

    <section class="feed" style="margin-top:16px;">
      <div class="feed-head"><span>Wallet</span><span>Accounts</span><span>Refunded SOL</span><span>Tx Signature</span><span>Date</span></div>
      <div id="feed"></div>
      <div class="row" style="justify-content:flex-end; margin-top:8px;">
        <button id="exportSession" class="btn ghost">Export session</button>
        <button id="loadMore" class="btn ghost">Load more</button>
      </div>
    </section>

    <footer>
      <div class="row" style="justify-content:space-between;">
        <div class="note">© BarbrickDesign 2025 · Built for contributors and coin holders</div>
        <div class="row">
          <a class="badge" href="https://www.barbrickdesign.com" target="_blank" rel="noopener">Main site</a>
          <a class="badge" href="https://github.com/barbrickdesign/barbrickdesign.github.io" target="_blank" rel="noopener">Repo</a>
          <a class="badge" href="https://github.com/barbrickdesign?tab=repositories" target="_blank" rel="noopener">GitHub</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- Solana client libraries -->
  <script src="https://unpkg.com/@solana/web3.js@1.95.6/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.3.11/dist/browser/spl-token.min.js"></script>
  <!-- EVM libraries (for wallet connect and basic queries) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>

  <script>
    // Connection (Solana)
    const solEndpoint = 'https://api.mainnet-beta.solana.com';
    const solConnection = new solanaWeb3.Connection(solEndpoint, 'confirmed');

    // Recovery constants
    const RENT_PER_EMPTY_ACCOUNT_SOL = 0.00204; // estimate per empty token account
    const DONATION_PCT = 0.05; // 5% support fee
    const REFERRAL_SPLIT_PCT_OF_DONATION = 0.20; // 20% of donation goes to referrer
    const FEE_WALLET = new solanaWeb3.PublicKey('5hSWosj58ki4A6hSfQrvteQU5QvyCWmhHn4AuqgaQzqr');

    // Token gate config (replace with your coin/NFT mints)
    const GATE_MINTS = [
      // 'YourCoinMintAddressHere',
    ];

    // Elements
    const walletLabel = document.getElementById('walletLabel');
    const refundEstimateBigEl = document.getElementById('refundEstimateBig');
    const emptyCountEl = document.getElementById('emptyCount');
    const refundEstimateEl = document.getElementById('refundEstimate');
    const sessionActionsEl = document.getElementById('sessionActions');
    const statusEl = document.getElementById('status');
    const refInput = document.getElementById('refAddress');
    const donationToggle = document.getElementById('donationToggle');
    const feedEl = document.getElementById('feed');
    const llmAccessBadge = document.getElementById('llmAccessBadge');
    const openLLMBtn = document.getElementById('openLLM');
    const chainSelect = document.getElementById('chainSelect');

    const connectBtn = document.getElementById('connectBtn');
    const resetBtn = document.getElementById('resetBtn');
    const scanBtn = document.getElementById('scanBtn');
    const recoverBtn = document.getElementById('recoverBtn');
    const recoverInlineBtn = document.getElementById('recoverInlineBtn');
    const exportSessionBtn = document.getElementById('exportSession');
    const loadMoreBtn = document.getElementById('loadMore');
    const mintSigilBtn = document.getElementById('mintSigil');
    const bookIntroBtn = document.getElementById('bookIntro');
    const copyReferralBtn = document.getElementById('copyReferral');
    const sendSupportBtn = document.getElementById('sendSupport');

    // State
    let chain = 'solana';
    let wallet = null; // Solana PublicKey or EVM address string
    let emptyTokenAccounts = []; // Solana only
    let sessionFeed = [];
    let sessionActions = 0;

    // Referral prefill
    const params = new URLSearchParams(window.location.search);
    const refFromUrl = params.get('ref') || params.get('summoner');
    if (refFromUrl) refInput.value = refFromUrl;

    // Switch chain
    chainSelect.addEventListener('change', (e) => {
      chain = e.target.value;
      setStatus(`Selected ${chain.toUpperCase()} for recovery.`);
      resetConnection(); // prompt reconnection per chain to ensure provider context
    });

    // Providers
    function getSolanaProvider() {
      const p = window.solana;
      if (p && (p.isPhantom || p.isBackpack || p.isOKXWallet)) return p;
      return null;
    }
    function getEvmProvider() {
      if (window.ethereum) return new ethers.BrowserProvider(window.ethereum);
      return null;
    }

    // Wallet connect
    async function connectWallet() {
      try {
        if (chain === 'solana') {
          const p = getSolanaProvider();
          if (!p) { setStatus('Install Phantom, Backpack, or a Solana wallet.'); return; }
          const resp = await p.connect();
          wallet = resp.publicKey;
          walletLabel.textContent = shorten(wallet.toBase58());
          setStatus('Solana wallet connected.');
          await scanEmptyAccountsSolana();
          await checkGateAccess();
          updateReferralPreview();
        } else {
          const provider = getEvmProvider();
          if (!provider) { setStatus('Install a web3 wallet (e.g., MetaMask).'); return; }
          const accounts = await provider.send('eth_requestAccounts', []);
          wallet = accounts[0];
          walletLabel.textContent = shorten(wallet);
          setStatus(`${chain.toUpperCase()} wallet connected.`);
          await mapEvmActivity(); // basic activity mapping via explorer links
          llmAccessBadge.textContent = 'Access: open (gate config pending)';
          openLLMBtn.disabled = false;
          updateReferralPreview();
        }
      } catch (e) {
        setStatus('Wallet connection canceled or failed.', 'error');
      }
    }

    function resetConnection() {
      try {
        if (chain === 'solana') {
          const p = getSolanaProvider();
          if (p) { try { p.disconnect(); } catch(_){} }
        } else {
          // EVM wallets typically don't expose disconnect; reset local state
        }
      } catch(_) {}
      wallet = null;
      walletLabel.textContent = '—';
      emptyTokenAccounts = [];
      refundEstimateBigEl.textContent = chain === 'solana' ? '0.00000 SOL' : '0.00000';
      emptyCountEl.textContent = '0';
      refundEstimateEl.textContent = '0.00000 SOL';
      llmAccessBadge.textContent = 'Access: locked';
      openLLMBtn.disabled = true;
      setStatus('Connection reset.');
    }

    // Solana: scan + estimate
    async function scanEmptyAccountsSolana() {
      if (!wallet) { setStatus('Connect a wallet first.', 'warn'); return; }
      setStatus('Scanning empty token accounts (Solana)...');
      try {
        const res = await solConnection.getParsedTokenAccountsByOwner(
          wallet,
          { programId: splToken.TOKEN_PROGRAM_ID }
        );
        emptyTokenAccounts = res.value
          .filter(acc => Number(acc.account.data.parsed.info.tokenAmount?.uiAmount || 0) === 0)
          .map(acc => ({ pubkey: acc.pubkey, mint: acc.account.data.parsed.info.mint }));
        const count = emptyTokenAccounts.length;
        const est = count * RENT_PER_EMPTY_ACCOUNT_SOL;
        emptyCountEl.textContent = count.toString();
        refundEstimateEl.textContent = toSol(est) + ' SOL';
        refundEstimateBigEl.textContent = toSol(est) + ' SOL';
        setStatus(`Found ${count} empty account(s).`);
      } catch (e) {
        console.error(e);
        setStatus('Scan failed. Try again.', 'error');
      }
    }

    // Solana: recover now
    async function recoverNowSolana() {
      if (!wallet) { setStatus('Connect a wallet first.', 'warn'); return; }
      if (emptyTokenAccounts.length === 0) { setStatus('No empty accounts to close.', 'warn'); return; }

      setStatus('Preparing recovery transactions...');
      const ownerPubkey = wallet;
      let closed = 0;
      let refundLamports = 0;
      const chunkSize = 8;

      for (let i = 0; i < emptyTokenAccounts.length; i += chunkSize) {
        const slice = emptyTokenAccounts.slice(i, i + chunkSize);
        const tx = new solanaWeb3.Transaction();
        for (const acc of slice) {
          const ix = splToken.createCloseAccountInstruction(
            new solanaWeb3.PublicKey(acc.pubkey),
            ownerPubkey, // rent destination
            ownerPubkey,
            []
          );
          tx.add(ix);
        }
        tx.feePayer = ownerPubkey;
        tx.recentBlockhash = (await solConnection.getLatestBlockhash()).blockhash;
        try {
          const sig = await signSendConfirmSolana(tx);
          closed += slice.length;
          refundLamports += slice.length * solanaWeb3.LAMPORTS_PER_SOL * RENT_PER_EMPTY_ACCOUNT_SOL;
          addFeedItem(ownerPubkey.toBase58(), slice.length, slice.length * RENT_PER_EMPTY_ACCOUNT_SOL, sig, new Date());
          setStatus(`Closed ${closed}/${emptyTokenAccounts.length} accounts...`);
        } catch (e) {
          console.error(e);
          setStatus('Some accounts failed to close. You can retry.', 'warn');
        }
      }

      // Optional 5% support + referral
      if (donationToggle.checked && refundLamports > 0) {
        const donationLamports = Math.floor(refundLamports * DONATION_PCT);
        const referralLamports = Math.floor(donationLamports * REFERRAL_SPLIT_PCT_OF_DONATION);
        const feeLamports = donationLamports - referralLamports;
        const referralAddr = safePubkey(refInput.value);
        const tx = new solanaWeb3.Transaction();
        if (feeLamports > 0) {
          tx.add(solanaWeb3.SystemProgram.transfer({ fromPubkey: ownerPubkey, toPubkey: FEE_WALLET, lamports: feeLamports }));
        }
        if (referralAddr && referralLamports > 0) {
          tx.add(solanaWeb3.SystemProgram.transfer({ fromPubkey: ownerPubkey, toPubkey: referralAddr, lamports: referralLamports }));
        }
        try {
          const sig = await signSendConfirmSolana(tx);
          addFeedItem(ownerPubkey.toBase58(), 0, lamportsToSol(donationLamports), sig, new Date());
          setStatus('Support and referral sent.', 'success');
        } catch (e) {
          console.error(e);
          setStatus('Support declined or failed.', 'warn');
        }
      }

      sessionActions += 1;
      sessionActionsEl.textContent = sessionActions.toString();
      await scanEmptyAccountsSolana();
      setStatus('Recovery complete.', 'success');
    }

    // EVM: mapping activity (basic)
    async function mapEvmActivity() {
      if (!wallet) { setStatus('Connect a wallet first.', 'warn'); return; }
      // For now, we guide users to explorers while stubbing client-side queries.
      // Deep recovery (dust sweeps, attack tracing) needs indexers/backends.
      const chainInfo = {
        ethereum: { explorer: 'https://etherscan.io/address/' },
        polygon: { explorer: 'https://polygonscan.com/address/' },
        bsc: { explorer: 'https://bscscan.com/address/' }
      };
      const info = chainInfo[chain];
      const link = info.explorer + wallet;
      setStatus(`Mapping ${chain.toUpperCase()} activity via explorer: ${link}`);
      // TODO: Add read-only JSON-RPC queries for token balances, approvals, and dust via ethers.js + public RPCs
      refundEstimateBigEl.textContent = '—'; // estimation depends on strategy per chain
    }

    // EVM: recover placeholder
    async function recoverNowEvm() {
      setStatus('Multi-chain recovery requires per-chain strategy (dust sweep, approvals revoke, and refunds). We will expand this module.', 'warn');
      alert('Recovery for EVM chains will be added with indexer + program support. For now, use the explorer link to identify dust and revoke approvals.');
    }

    // Token-gate for LLM (Solana holdings)
    async function checkGateAccess() {
      if (!wallet) { setStatus('Connect a wallet to check access.', 'warn'); return; }
      if (GATE_MINTS.length === 0) { // no mints configured yet — open for testing
        llmAccessBadge.textContent = 'Access: open (config pending)';
        openLLMBtn.disabled = false;
        return;
      }
      try {
        const res = await solConnection.getParsedTokenAccountsByOwner(wallet, { programId: splToken.TOKEN_PROGRAM_ID });
        const userMints = new Set(res.value.map(acc => acc.account.data.parsed.info.mint));
        const hasRequired = GATE_MINTS.some(mint => userMints.has(mint));
        llmAccessBadge.textContent = hasRequired ? 'Access: unlocked' : 'Access: locked';
        openLLMBtn.disabled = !hasRequired;
      } catch (e) {
        console.error(e);
        setStatus('Token-gate check failed.', 'error');
      }
    }

    // Open LLM modal (placeholder UI; wire to your backend/inference)
    function openLLM() {
      alert('LLM is gated for coin holders. Replace this with your chat UI and API endpoint.');
    }

    // Utils
    function updateReferralPreview() {
      const base = location.origin + location.pathname;
      const ref = refInput.value ? ('?ref=' + encodeURIComponent(refInput.value)) : '';
      document.getElementById('refPreview').textContent = base + ref;
    }
    async function signSendConfirmSolana(tx) {
      const provider = getSolanaProvider();
      const signed = await provider.signAndSendTransaction(tx);
      const sig = signed.signature || signed;
      await solConnection.confirmTransaction(sig, 'confirmed');
      return sig;
    }
    function addFeedItem(walletAddr, accounts, sol, sig, date) {
      sessionFeed.unshift({ wallet: walletAddr, accounts, sol, sig, date: date.toISOString() });
      renderFeed();
    }
    function renderFeed() {
      feedEl.innerHTML = '';
      for (const it of sessionFeed.slice(0, 24)) {
        const row = document.createElement('div');
        row.className = 'feed-row';
        row.innerHTML = `
          <span class="mono">${shorten(it.wallet)}</span>
          <span>${it.accounts}</span>
          <span>${toSol(it.sol)} SOL</span>
          <span class="mono">${shorten(it.sig || '')}</span>
          <span>${new Date(it.date).toLocaleString()}</span>
        `;
        feedEl.appendChild(row);
      }
    }
    function exportSession() {
      const blob = new Blob([JSON.stringify({ feed: sessionFeed }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `barbrick-session-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
    function setStatus(msg, kind = 'info') {
      statusEl.textContent = msg;
      statusEl.style.color = kind === 'error' ? 'var(--bad)' : kind === 'warn' ? 'var(--warn)' : kind === 'success' ? 'var(--good)' : 'var(--muted)';
    }
    function shorten(s) { if (!s) return '—'; return s.length > 12 ? (s.slice(0,4) + '...' + s.slice(-4)) : s; }
    function toSol(n) { return (Math.round(n * 100000) / 100000).toFixed(5); }
    function lamportsToSol(l) { return l / solanaWeb3.LAMPORTS_PER_SOL; }
    function solToLamports(s) { return Math.floor(s * solanaWeb3.LAMPORTS_PER_SOL); }
    function safePubkey(s) { try { return s ? new solanaWeb3.PublicKey(s) : null; } catch(_) { return null; } }

    // Wire up
    connectBtn.addEventListener('click', connectWallet);
    resetBtn.addEventListener('click', resetConnection);
    scanBtn.addEventListener('click', () => { chain === 'solana' ? scanEmptyAccountsSolana() : mapEvmActivity(); });
    recoverBtn.addEventListener('click', () => { chain === 'solana' ? recoverNowSolana() : recoverNowEvm(); });
    recoverInlineBtn.addEventListener('click', () => { chain = 'solana'; recoverNowSolana(); });
    exportSessionBtn.addEventListener('click', exportSession);
    loadMoreBtn.addEventListener('click', () => setStatus('Session-only feed. Add a backend for global feed.', 'warn'));
    openLLMBtn.addEventListener('click', openLLM);
    mintSigilBtn.addEventListener('click', () => alert('Mint flow placeholder. Connect to your mint API or on-chain program.'));
    bookIntroBtn.addEventListener('click', () => alert('Add Calendly or booking embed here.'));
    copyReferralBtn.addEventListener('click', () => { updateReferralPreview(); navigator.clipboard.writeText(document.getElementById('refPreview').textContent); setStatus('Referral link copied.', 'success'); });
    sendSupportBtn.addEventListener('click', async () => {
      if (!wallet || chain !== 'solana') { setStatus('Connect Solana wallet to send a tip.', 'warn'); return; }
      const tx = new solanaWeb3.Transaction().add(solanaWeb3.SystemProgram.transfer({
        fromPubkey: wallet, toPubkey: FEE_WALLET, lamports: solanaWeb3.LAMPORTS_PER_SOL * 0.01 // 0.01 SOL tip
      }));
      tx.feePayer = wallet;
      tx.recentBlockhash = (await solConnection.getLatestBlockhash()).blockhash;
      try { await signSendConfirmSolana(tx); setStatus('Thanks for the support!', 'success'); } catch (e) { setStatus('Tip failed or declined.', 'warn'); }
    });

    // Init
    updateReferralPreview();
  </script>
</body>
</html>
