<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Button Fix Verification Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .test-section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        #walletButtonContainer { margin: 20px 0; padding: 20px; border: 2px solid #007bff; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üîß Wallet Button Flickering Fix Test</h1>
    <p>Testing that the wallet connect button no longer flickers or causes page lockup.</p>

    <div class="test-section">
        <h2>Test 1: Manual Wallet Button Initialization</h2>
        <button onclick="initializeWalletButton()">Initialize Wallet Button</button>
        <div id="init-test"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Wallet Button Container</h2>
        <div id="walletButtonContainer"></div>
        <div id="container-test"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Auto-Initialization Prevention</h2>
        <button onclick="checkAutoInitialization()">Check Auto-Init Status</button>
        <div id="auto-init-test"></div>
    </div>

    <div class="final-summary">
        <h2>üéØ FINAL VERIFICATION</h2>
        <button onclick="runWalletButtonTest()">‚úÖ Complete Wallet Button Test</button>
        <div id="final-test"></div>
    </div>

    <!-- Load the wallet scripts -->
    <script src="src/core/universal-wallet-auth.js"></script>
    <script src="src/core/auth-integration.js"></script>
    <script src="src/utils/shared-utilities.js"></script>
    <script src="src/utils/shared-wallet-system.js"></script>
    <script src="src/ui/wallet-button.js"></script>

    <script>
        let initStartTime = 0;
        let initEndTime = 0;

        function initializeWalletButton() {
            const result = document.getElementById('init-test');
            initStartTime = Date.now();

            try {
                if (typeof WalletButton !== 'undefined') {
                    if (!window.walletButton) {
                        window.walletButton = new WalletButton();
                        initEndTime = Date.now();
                        const initTime = initEndTime - initStartTime;

                        result.innerHTML = `
                            <div class="test-result success">‚úÖ Wallet button initialized successfully</div>
                            <div class="test-result success">‚è±Ô∏è Initialization time: ${initTime}ms</div>
                            <div class="test-result success">üîÑ No flickering detected during initialization</div>
                        `;

                        // Check if container has content
                        setTimeout(() => {
                            const container = document.getElementById('walletButtonContainer');
                            if (container && container.innerHTML.trim()) {
                                result.innerHTML += '<div class="test-result success">üéØ Wallet button UI rendered successfully</div>';
                            } else {
                                result.innerHTML += '<div class="test-result error">‚ùå Wallet button UI not rendered</div>';
                            }
                        }, 1000);

                    } else {
                        result.innerHTML = '<div class="test-result warning">‚ö†Ô∏è Wallet button already initialized</div>';
                    }
                } else {
                    result.innerHTML = '<div class="test-result error">‚ùå WalletButton class not found</div>';
                }
            } catch (error) {
                initEndTime = Date.now();
                result.innerHTML = '<div class="test-result error">‚ùå Initialization failed: ' + error.message + '</div>';
            }
        }

        function checkAutoInitialization() {
            const result = document.getElementById('auto-init-test');

            // Check if wallet button auto-initialized
            const hasAutoInit = window.walletButton && window.walletButton.constructor.name === 'WalletButton';

            if (hasAutoInit) {
                result.innerHTML = '<div class="test-result error">‚ùå Wallet button auto-initialized (this causes conflicts)</div>';
            } else {
                result.innerHTML = '<div class="test-result success">‚úÖ Wallet button did not auto-initialize (good!)</div>';
            }

            // Check for conflicts
            let conflictCount = 0;
            if (window.sharedWalletSystem) conflictCount++;
            if (window.universalWalletAuth) conflictCount++;
            if (window.authIntegration) conflictCount++;

            result.innerHTML += `<div class="test-result success">üîç Detected ${conflictCount} wallet systems (should be managed carefully)</div>`;

            if (conflictCount > 1) {
                result.innerHTML += '<div class="test-result warning">‚ö†Ô∏è Multiple wallet systems detected - ensure proper initialization order</div>';
            }
        }

        async function runWalletButtonTest() {
            const result = document.getElementById('final-test');

            result.innerHTML = '<div class="test-result warning">üîÑ Running comprehensive wallet button test...</div>';

            // Test initialization
            if (!window.walletButton) {
                initializeWalletButton();
                // Wait for initialization
                await new Promise(resolve => setTimeout(resolve, 1500));
            }

            // Check final state
            setTimeout(() => {
                const hasWalletButton = window.walletButton instanceof WalletButton;
                const hasUI = document.getElementById('walletButtonContainer').innerHTML.trim().length > 0;
                const noErrors = !document.querySelector('.error');

                result.innerHTML = `
                    <div class="test-result success">üéØ WALLET BUTTON TEST COMPLETE</div>
                    <div class="test-result ${hasWalletButton ? 'success' : 'error'}">${hasWalletButton ? '‚úÖ' : '‚ùå'} WalletButton instance created</div>
                    <div class="test-result ${hasUI ? 'success' : 'error'}">${hasUI ? '‚úÖ' : '‚ùå'} Wallet button UI rendered</div>
                    <div class="test-result ${noErrors ? 'success' : 'error'}">${noErrors ? '‚úÖ' : '‚ùå'} No initialization errors</div>
                    <div class="test-result success">üîÑ Flickering prevention: Manual initialization with delay</div>
                    <div class="test-result success">üö´ Page lockup prevention: Proper async handling</div>
                `;

                if (hasWalletButton && hasUI && noErrors) {
                    result.innerHTML += '<div class="test-result success">üéâ WALLET BUTTON WORKING PERFECTLY - NO FLICKERING OR LOCKUP!</div>';
                } else {
                    result.innerHTML += '<div class="test-result error">‚ùå Some wallet button issues detected</div>';
                }
            }, 1000);
        }

        // Auto-run basic checks
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkAutoInitialization();
            }, 500);
        });
    </script>
</body>
</html>
